!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.camlsql=t()}(this,function(){"use strict";function e(e){var t,r=0;if("string"!=typeof e)throw"[camlsql] Interval value must be a string";if(t=e.match(/^(\d+) (month|day|hour|minute|second|ms|millisecond)s?$/)){switch(e=parseInt(e,10),t[2]){case"month":r=2592e3*e;break;case"day":r=24*e*60*60;break;case"hour":r=60*e*60;break;case"minute":r=60*e;break;case"second":r=e;break;case"ms":case"millisecond":r=e/1e3}return 1e3*r}throw"[camlsql] Interval string was not recognized: "+e}function t(e,t){t=!!t,(e=e?new Date(+e):new Date).setHours(0,0,0,0);var r=e.getDay();return!0===t&&(0==r?r=6:r-=1),e.setDate(e.getDate()-r),e}function r(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function n(e){var t=l(e);return t&&(t.includeTime=!1),t}function l(e){var t;return 0==arguments.length?a(0,!0):("string"==typeof e&&("month start"==e?(new Date,e=d.getFullYear()+"-"+f(d.getMonth()+1)+"-01T00:00:00Z"):"month end"==e?(new Date,e=(t=new Date(d.getFullYear(),d.getMonth()+1,0)).getFullYear()+"-"+f(t.getMonth()+1)+"-"+f(t.getDate())+"T23:59:59Z"):"this morning"==e?(new Date,e=d.getFullYear()+"-"+f(d.getMonth()+1)+"-"+f(d.getDate())+"T00:00:00Z"):"tonight"==e&&(new Date,e=d.getFullYear()+"-"+f(d.getMonth()+1)+"-"+f(d.getDate())+"T23:59:59Z")),"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e,includeTime:!0}:(console.error("[camlsql] Bad format for datetime value"),null))}function a(e,t){if(void 0===e&&(e=0),"number"!=typeof e)throw"[camlsql] Bad offset value for 'today'";return{type:"DateTime",today:!0,value:e,includeTime:!0===t}}function o(e){return{type:"Guid",value:e}}function s(e){return{type:"MultiChoice",value:e}}function u(e){return{type:"Choice",value:e}}function i(e){return{type:"URL",value:e}}function c(e){return{type:"User",value:e}}function m(e){function t(){var e=new SP.CamlQuery,t=m;e.set_viewXml(t),console.log("camlQuery",e),c=u.getItems(e),n.load(c),n.executeQueryAsync(r,function(){s({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:getSql,viewXml:m,listName:i,error:Array.prototype.slice.call(arguments)}},null)})}function r(){var e,t=c.getEnumerator(),r=[],n=c.get_listItemCollectionPosition();for(n&&(l=n.get_pagingInfo());t.moveNext();)e=t.get_current(),a||(a="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id())),r.push(e.get_fieldValues());s(null,r,{nextPage:l,prevPage:a})}var n,l,a,o=e.spWeb,s=e.callback,u=null,i=e.query.getListName(),c=null,m=e.query.getXml();return"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){n=SP.ClientContext.get_current(),null===o&&(o=n.get_web(),u=o.get_lists().getByTitle(i),n.load(u),n.executeQueryAsync(t,function(){s({status:"error",message:"Failed to load list",data:{sql:getSql,viewXml:m,listName:i,error:Array.prototype.slice.call(arguments)}},null)}))}):s({status:"error",message:"SP is not defined",data:null},null),console.log({web:o,callback:s}),publicItems}function f(e,t){for(var r=String(e);r.length<(t||2);)r="0"+r;return r}function g(e){return e.replace(/^\s+|\s+$/g,"")}function p(e){return g(e).replace(/^\[|\]$/g,"")}function y(e,t){var r=this,n=_(t);console.log("parameters",n),this.exec=function(){var e,t,r=Array.prototype.slice.call(arguments);return r.length>1?"object"==typeof r[0]&&(e=r[0],"function"==typeof r[1]&&(t=r[1])):1==r.length&&("object"==typeof r[0]?e=r[0]:"function"==typeof r[0]&&(t=r[0])),m({query:this,callback:t,spWeb:e})},this.getXml=function(){return new x(r)},this.$options={parsedQuery:T(e)}}function _(e){var t,r,n={};if(e&&e.length>0)for(t=0;t<e.length;t++)(r=h(e[t]))&&(n["@param"+t]=r);return n}function h(e){var t,n=null;if(null==e)return null;if(null!==e&&e.constructor===Array)for(n=[],t=0;t<e.length;t++)n.push(h(e[t]));else if("string"==typeof e)n=r(e);else if("number"==typeof e)n=camlsql.number(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return n}function v(e){var t;(t=e.query.match(/\sLIMIT\s(\d+).*$/i))&&(e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10))}function w(e){var t,r=[],n=e.query.match(/^SELECT\s(.*?)\sFROM\s(.*?)(?:\s+(where.*)$|$)/i);if(n)if(4==n.length){for(r=b(n[1]),t=0;t<r.length;t++)r[t].match(/^[a-z:A-Z_\\d]+$/)||console.warn&&console.warn("[camlsql] Doubtful field name: "+r[t]);e.fields=r,p(n[2]),e.query=n[3]}else e.query=""}function b(e){var t,r=[],n=e.split(",");for(t=0;t<n.length;t++)n[t]=p(n[t]),r.push(n[t]);return 1==r.length&&"*"==r[0]&&(r=[]),r}function q(e,t){var r,n,l,a,o,s,u=[],i=e.query,c=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(s=i.match(/\sORDER\sBY\s(.*?)$/i)){if(a=s[1],i=i.substr(0,i.length-s[0].length),void 0!==a&&null!==a)for(;r=c.exec(a);){if(o=!0,l=null,r[1].indexOf(":")>0){if(!(2==(s=r[1].split(":")).length&&s[0].length>0))return[];switch(s[0]=s[0].toLowerCase(),s[0]){case"datetime":s[0]="DateTime";break;case"text":s[0]="Text";break;case"number":s[0]="Number";break;case"datetime":s[0]="DateTime"}l=s[0],r[1]=s[1]}else console.error&&console.error("[camlsql] Error in ORDER BY statement: "+r[1]);n=p(r[1]),3==r.length&&(o="desc"!=(void 0!==r[2]?g(r[2].toLowerCase()):null)),u.push([n,o,l])}e.sort=u}}function D(e){var t,r,n=e.query;if(t=n.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":r="DefaultValue";break;case"recursive":r="Recursive";break;case"recursiveall":r="RecursiveAll";break;case"filesonly":r="FilesOnly"}if(!r&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==r&&(e.viewScope=r),e.query=t[1]+n.substr(t[1].length+t[2].length)}else e.viewScope=null}function T(e,t){var r,n={query:e,rowLimit:0,fields:[],sort:[],viewScope:null,macros:[],statements:[]};return D(n),v(n),q(n),w(n),r=P(n.query),n.statements=r.statements,n.macros=r.macros,n.query=e,n}function x(){return{xml:null,errors:null}}var C,P=function(e,t){function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var s,u,i,c,m,f,d,g,p,y=null,_=null,h=[],v=0;for(s=0;s<e.length;s++)e[s]==a?(0==v&&(s>0&&h.push(e.substring(0,s)),y=s,_=null),v++):e[s]==o&&null!==y&&0==--v&&(h.push(r(e.substring(y,s+1)).replace(/^\(|\)$/g,"")),_=s+1);for(null!=_?h.push(r(e.substring(_))):0==h.length&&null==y&&null==_&&h.push(r(e)),s=0;s<h.length;s++)if(u="and",h[s].match(/^\s*(\|\||(or))\s*/i)&&(u="or"),h[s].match(/\s*(?:\|\||(or))\s*$/gi)&&s<h.length-1&&(h[s+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(h[s+1]="or "+h[s+1])),h[s]=h[s].replace(/\s*(\&\&|and)\s*$/i,""),h[s]=h[s].replace(/\s*(\|\||or)\s*$/i,""),h[s]=h[s].replace(/^\s*(\&\&|and)\s*/i,""),h[s]=h[s].replace(/^\s*(\|\||or)\s*/i,""),h[s]={type:"statement",value:h[s],operator:u},-1!==h[s].value.indexOf(a))(c=n(h[s].value)).length>1&&(h[s].type="group",h[s].items=c);else{for(i=h[s].value.split(/ (\|\||or|and|\&\&) /i),h[s].type="statement",m=[],f=0;f<i.length;f++)if(d={type:"statement",operator:"and"},""!=r(i[f])&&"and"!=i[f].toLowerCase()&&"or"!=i[f].toLowerCase()&&"||"!=i[f]&&"&&"!=i[f])if(f>0&&("or"!=i[f-1].toLowerCase()&&"||"!=i[f-1]||(d.operator="or")),g=l(i[f]))d.field=g.field,d.macro=g.macro,d.comparison=g.comparison,m.push(d);else if(!t)throw"[casql] Could not parse statement: "+i[f];m.length>1?(h[s].type="group",h[s].items=m):1==m.length&&(h[s].field=m[0].field,h[s].macro=m[0].macro,h[s].comparison=m[0].comparison)}for(p=[],s=0;s<h.length;s++)h[s].value&&p.push(h[s]);return p}function l(e){if(void 0===e)return null;var n=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(n){var l="eq",a="@param"+i,o=r(n[2]);if(">"==o&&(l="gt"),">="==o&&(l="gte"),"<"==o&&(l="lt"),"<="==o&&(l="lte"),"=="==o&&(l="eq"),"<>"!=o&&"!="!=o||(l="ne"),"like"==o.toLowerCase()&&(l="like"),"isnull"==o.toLowerCase()&&(l="null"),"isnotnull"==o.toLowerCase()&&(l="notnull"),"in"==o.toLowerCase()&&(l="in"),"null"!=l&&"notnull"!=l){if(i++,c++,null==s)s=n[3];else if(s!=n[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==n[3][0]&&(a=n[3]),m.push(a)}else a=null;return{field:p(n[1]),comparison:l,macro:a}}return null}var a="(",o=")",s=null,u={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return u;var i=0,c=0,m=[],f=n(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==f&&(u.statements=f),u.macroType=s,u.macroCount=c,u.macros=m,u};return C={prepare:function(e,t){return new y(e,t)},text:r,guid:o,number:function(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a number";return e=e||0,{type:"Number",value:e}},lookup:function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},date:n,datetime:l,today:a,multichoice:s,choice:u,url:i,user:c},C.__testonly__=C.__testonly__||{},C.__testonly__.padString=f,C.__testonly__.extractOrderByPart=q,C.__testonly__.extractListAndFieldNameParts=w,C.__testonly__.extractScopePart=D,C.__testonly__.extractLimitPart=v,C.__testonly__.parseSqlQuery=T,C.__testonly__.whereParser=P,C.__testonly__.createDateParameter=n,C.__testonly__.createDateTimeParameter=l,C.__testonly__.createTodayParameter=a,C.__testonly__.createGuidParameter=o,C.__testonly__.createMultiChoiceParameter=s,C.__testonly__.createChoiceParameter=u,C.__testonly__.createUrlParameter=i,C.__testonly__.createUserParameter=c,C.__testonly__.encodeHTML=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},C.__testonly__.trim=g,C.__testonly__.formatFieldName=p,C.__testonly__.getIntervalStringAsMs=e,C.__testonly__.createDateWithIntervalString=function(t){var r=e(t);return new Date((new Date).getTime()+r)},C.__testonly__.getDateFromTextualRepresentation=function(e){var r,n,l;return e=g(e.toLowerCase()),r=new Date,"month start"==e?l=r.getFullYear()+"-"+f(r.getMonth()+1)+"-01T00:00:00Z":"month end"==e?l=(n=new Date(r.getFullYear(),r.getMonth()+1,0)).getFullYear()+"-"+f(n.getMonth()+1)+"-"+f(n.getDate())+"T23:59:59Z":"week start"==e?l=(n=t(new Date)).getFullYear()+"-"+f(n.getMonth()+1)+"-"+f(n.getDate())+"T00:00:00Z":"week start monday"==e&&(l=(n=t(new Date,!0)).getFullYear()+"-"+f(n.getMonth()+1)+"-"+f(n.getDate())+"T00:00:00Z"),l},C});