!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.camlsql=t()}(this,function(){"use strict";function e(e){var t,n=0;if("string"!=typeof e)throw"[camlsql] Interval value must be a string";if(t=e.match(/^(\d+) (month|day|hour|minute|second|ms|millisecond)s?$/)){switch(e=parseInt(e,10),t[2]){case"month":n=2592e3*e;break;case"day":n=24*e*60*60;break;case"hour":n=60*e*60;break;case"minute":n=60*e;break;case"second":n=e;break;case"ms":case"millisecond":n=e/1e3}return 1e3*n}throw"[camlsql] Interval string was not recognized: "+e}function t(e,t){var a,o;return e=g(e.toLowerCase()),t=t?new Date(+t):new Date,"month start"==e?o=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0):"month end"==e?o=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999):"week start"==e?o=(a=n(new Date)).getFullYear()+"-"+y(a.getMonth()+1)+"-"+y(a.getDate())+"T00:00:00Z":"week start monday"==e?o=(a=n(new Date,!0)).getFullYear()+"-"+y(a.getMonth()+1)+"-"+y(a.getDate())+"T00:00:00Z":"week end monday"==e?o=(a=r(new Date,!0)).getFullYear()+"-"+y(a.getMonth()+1)+"-"+y(a.getDate())+"T00:00:00Z":"week end"==e?o=(a=r(new Date)).getFullYear()+"-"+y(a.getMonth()+1)+"-"+y(a.getDate())+"T00:00:00Z":"day start"==e?o=new Date(t.setHours(0,0,0,0)):"day end"==e&&(o=new Date(t.setHours(23,59,59,999))),o}function n(e,t){(e=e?new Date(+e):new Date).setHours(0,0,0,0),t=!!t;var n=e.getDay();return!0===t&&(0==n?n=6:n-=1),e.setDate(e.getDate()-n),e}function r(e,t){return e=n(e,t),e.getDay(),e.setDate(e.getDate()+6),e}function a(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function o(e){var t=l(e);return t&&(t.includeTime=!1),t}function l(e){var t=!1;return e&&e.__proto__==R&&(e=e.value),e||(t=!0),e=e?new Date(+e):new Date,Object.create(R,{type:{value:"DateTime"},value:{value:e,writable:!0},includeTime:{value:!0,writable:!0},today:{value:t,writable:!0},storageTZ:{value:!0,writable:!0}})}function s(e,t){if(void 0===e&&(e=0),"number"!=typeof e)throw"[camlsql] Bad offset value for 'today'";return{type:"DateTime",today:!0,value:e,includeTime:!0===t}}function i(e){return{type:"Guid",value:e}}function u(e){return{type:"MultiChoice",value:e}}function c(e){return{type:"Choice",value:e}}function f(e){return{type:"URL",value:e}}function m(e){return{type:"User",value:e}}function d(e){function t(){var e=new SP.CamlQuery,t=f;e.set_viewXml(t),console.log("camlQuery",e),c=i.getItems(e),r.load(c),r.executeQueryAsync(n,function(){s({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:getSql,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)})}function n(){var e,t=c.getEnumerator(),n=[],r=c.get_listItemCollectionPosition();for(r&&(a=r.get_pagingInfo());t.moveNext();)e=t.get_current(),o||(o="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id())),n.push(e.get_fieldValues());s(null,n,{nextPage:a,prevPage:o})}var r,a,o,l=e.spWeb,s=e.callback,i=null,u=e.query.getListName(),c=null,f=e.query.getXml();return"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){r=SP.ClientContext.get_current(),null===l&&(l=r.get_web(),i=l.get_lists().getByTitle(u),r.load(i),r.executeQueryAsync(t,function(){s({status:"error",message:"Failed to load list",data:{sql:getSql,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)}))}):s({status:"error",message:"SP is not defined",data:null},null),console.log({web:l,callback:s}),publicItems}function y(e,t){for(var n=String(e);n.length<(t||2);)n="0"+n;return n}function p(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function g(e){return e.replace(/^\s+|\s+$/g,"")}function h(e){return g(e).replace(/^\[|\]$/g,"")}function _(e,t){var n=this,r=v(t);console.log("parameters",r),this.exec=function(){var e,t,n=Array.prototype.slice.call(arguments);return n.length>1?"object"==typeof n[0]&&(e=n[0],"function"==typeof n[1]&&(t=n[1])):1==n.length&&("object"==typeof n[0]?e=n[0]:"function"==typeof n[0]&&(t=n[0])),d({query:this,callback:t,spWeb:e})},this.getXml=function(){return new C(n)},this.$options={parsedQuery:x(e),parameters:r}}function v(e){var t,n,r={};if(e&&e.length>0)for(t=0;t<e.length;t++)(n=w(e[t]))&&(r["@param"+t]=n);return r}function w(e){var t,n=null;if(null==e)return null;if(null!==e&&e.constructor===Array)for(n=[],t=0;t<e.length;t++)n.push(w(e[t]));else if("string"==typeof e)n=a(e);else if("number"==typeof e)n=camlsql.number(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return n}function b(e){var t;(t=e.query.match(/\sLIMIT\s(\d+).*$/i))&&(e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10))}function D(e){var t,n=[],r=e.query.match(/^SELECT\s(.*?)\sFROM\s(.*?)(?:\s+(where.*)$|$)/i);if(r)if(4==r.length){for(n=T(r[1]),t=0;t<n.length;t++)n[t].match(/^[a-z:A-Z_\\d]+$/)||console.warn&&console.warn("[camlsql] Doubtful field name: "+n[t]);e.fields=n,h(r[2]),e.query=r[3]}else e.query=""}function T(e){var t,n=[],r=e.split(",");for(t=0;t<r.length;t++)r[t]=h(r[t]),n.push(r[t]);return 1==n.length&&"*"==n[0]&&(n=[]),n}function q(e,t){var n,r,a,o,l,s,i=[],u=e.query,c=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(s=u.match(/\sORDER\sBY\s(.*?)$/i)){if(o=s[1],u=u.substr(0,u.length-s[0].length),void 0!==o&&null!==o)for(;n=c.exec(o);){if(l=!0,a=null,n[1].indexOf(":")>0){if(!(2==(s=n[1].split(":")).length&&s[0].length>0))return[];switch(s[0]=s[0].toLowerCase(),s[0]){case"datetime":s[0]="DateTime";break;case"text":s[0]="Text";break;case"number":s[0]="Number";break;case"datetime":s[0]="DateTime"}a=s[0],n[1]=s[1]}else console.error&&console.error("[camlsql] Error in ORDER BY statement: "+n[1]);r=h(n[1]),3==n.length&&(l="desc"!=(void 0!==n[2]?g(n[2].toLowerCase()):null)),i.push([r,l,a])}e.sort=i}}function k(e){var t,n,r=e.query;if(t=r.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":n="DefaultValue";break;case"recursive":n="Recursive";break;case"recursiveall":n="RecursiveAll";break;case"filesonly":n="FilesOnly"}if(!n&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==n&&(e.viewScope=n),e.query=t[1]+r.substr(t[1].length+t[2].length)}else e.viewScope=null}function x(e,t){var n,r={query:e,rowLimit:0,fields:[],sort:[],viewScope:null,macros:[],statements:[]};return k(r),b(r),q(r),D(r),n=$(r.query),r.statements=n.statements,r.macros=n.macros,r.query=e,r}function C(e){var t="",n=e.$options.parsedQuery,r=n.$options;return t+=S(F,{Scope:n.viewScope}),t+=L(n.fields),t+=P(n.statements,r),t+=E("View"),console.log("query",e),{xml:t,errors:null}}function P(e,t){return console.warn("CREATE QUERY ELEMENT",e,t),"<Query />"}function L(e){var t,n="";if(e.length>0)for(t=0;t<e.length;t++)n+=S(I),n+=S(M,{Name:e[t]},!0),n+=E(I);return n}function S(e,t,n){var r,a="<"+e,o=t?Object.keys(t):[];for(r=0;r<o.length;r++)void 0!==t[o[r]]&&null!==t[o[r]]&&(a+=" "+o[r]+'="'+p(t[o[r]])+'"');return a+(n?" /":"")+">"}function E(e){return"</"+e+">"}var O,R={type:"DateTime",today:!1,includeTime:!1,value:null,storageTZ:!0,startOfWeek:function(e){return this.value=t("week start"+(e?"":" monday")),this.isToday=!1,this},endOfWeek:function(e){return this.value=t("week end"+(e?"":" monday")),this.isToday=!1,this},startOfMonth:function(){return this.value=t("month start"),this.isToday=!1,this},endOfMonth:function(){return this.value=t("month end"),this.isToday=!1,this},endOfDay:function(){return this.value=t("day end"),this.isToday=!1,this},startOfDay:function(){return this.value=t("day start"),this.isToday=!1,this},storageTZ:function(e){return this.storageTZ=!!e,this.isToday=!1,this}},$=function(e,t){function n(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){var s,i,u,c,f,m,d,y,p,g=null,h=null,_=[],v=0;for(s=0;s<e.length;s++)e[s]==o?(0==v&&(s>0&&_.push(e.substring(0,s)),g=s,h=null),v++):e[s]==l&&null!==g&&0==--v&&(_.push(n(e.substring(g,s+1)).replace(/^\(|\)$/g,"")),h=s+1);for(null!=h?_.push(n(e.substring(h))):0==_.length&&null==g&&null==h&&_.push(n(e)),s=0;s<_.length;s++)if(i="and",_[s].match(/^\s*(\|\||(or))\s*/i)&&(i="or"),_[s].match(/\s*(?:\|\||(or))\s*$/gi)&&s<_.length-1&&(_[s+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(_[s+1]="or "+_[s+1])),_[s]=_[s].replace(/\s*(\&\&|and)\s*$/i,""),_[s]=_[s].replace(/\s*(\|\||or)\s*$/i,""),_[s]=_[s].replace(/^\s*(\&\&|and)\s*/i,""),_[s]=_[s].replace(/^\s*(\|\||or)\s*/i,""),_[s]={type:"statement",value:_[s],operator:i},-1!==_[s].value.indexOf(o))(c=r(_[s].value)).length>1&&(_[s].type="group",_[s].items=c);else{for(u=_[s].value.split(/ (\|\||or|and|\&\&) /i),_[s].type="statement",f=[],m=0;m<u.length;m++)if(d={type:"statement",operator:"and"},""!=n(u[m])&&"and"!=u[m].toLowerCase()&&"or"!=u[m].toLowerCase()&&"||"!=u[m]&&"&&"!=u[m])if(m>0&&("or"!=u[m-1].toLowerCase()&&"||"!=u[m-1]||(d.operator="or")),y=a(u[m]))d.field=y.field,d.macro=y.macro,d.comparison=y.comparison,f.push(d);else if(!t)throw"[casql] Could not parse statement: "+u[m];f.length>1?(_[s].type="group",_[s].items=f):1==f.length&&(_[s].field=f[0].field,_[s].macro=f[0].macro,_[s].comparison=f[0].comparison)}for(p=[],s=0;s<_.length;s++)_[s].value&&p.push(_[s]);return p}function a(e){if(void 0===e)return null;var r=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(r){var a="eq",o="@param"+u,l=n(r[2]);if(">"==l&&(a="gt"),">="==l&&(a="gte"),"<"==l&&(a="lt"),"<="==l&&(a="lte"),"=="==l&&(a="eq"),"<>"!=l&&"!="!=l||(a="ne"),"like"==l.toLowerCase()&&(a="like"),"isnull"==l.toLowerCase()&&(a="null"),"isnotnull"==l.toLowerCase()&&(a="notnull"),"in"==l.toLowerCase()&&(a="in"),"null"!=a&&"notnull"!=a){if(u++,c++,null==s)s=r[3];else if(s!=r[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==r[3][0]&&(o=r[3]),f.push(o)}else o=null;return{field:h(r[1]),comparison:a,macro:o}}return null}var o="(",l=")",s=null,i={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return i;var u=0,c=0,f=[],m=r(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==m&&(i.statements=m),i.macroType=s,i.macroCount=c,i.macros=f,i},F="View",I="ViewFields",M="FieldRef";return O={prepare:function(e,t){return new _(e,t)},text:a,guid:i,number:function(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a number";return e=e||0,{type:"Number",value:e}},lookup:function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},date:o,datetime:l,today:s,multichoice:u,choice:c,url:f,user:m},O.__testonly__=O.__testonly__||{},O.__testonly__.padString=y,O.__testonly__.extractOrderByPart=q,O.__testonly__.extractListAndFieldNameParts=D,O.__testonly__.extractScopePart=k,O.__testonly__.extractLimitPart=b,O.__testonly__.parseSqlQuery=x,O.__testonly__.whereParser=$,O.__testonly__.createDateParameter=o,O.__testonly__.createDateTimeParameter=l,O.__testonly__.createTodayParameter=s,O.__testonly__.createGuidParameter=i,O.__testonly__.createMultiChoiceParameter=u,O.__testonly__.createChoiceParameter=c,O.__testonly__.createUrlParameter=f,O.__testonly__.createUserParameter=m,O.__testonly__.encodeHTML=p,O.__testonly__.trim=g,O.__testonly__.formatFieldName=h,O.__testonly__.getIntervalStringAsMs=e,O.__testonly__.createDateWithIntervalString=function(t){var n=e(t);return new Date((new Date).getTime()+n)},O.__testonly__.getDateFromTextualRepresentation=t,O});