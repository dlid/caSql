!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():e.camlsql=t()}(this,function(){"use strict";function e(e){var t,r=0;if("string"!=typeof e)throw"[camlsql] Interval value must be a string";if(e=e.toLowerCase(),t=e.match(/^(\d+) (day|hour|minute|second|ms|millisecond)s?$/i)){switch(e=parseInt(e,10),t[2]){case"day":r=24*e*60*60;break;case"hour":r=60*e*60;break;case"minute":r=60*e;break;case"second":r=e;break;case"ms":case"millisecond":r=e/1e3}return 1e3*r}throw"[camlsql] Interval string was not recognized: "+e}function t(e,t){var l;return e=g(e.toLowerCase()),t=t?new Date(+t):new Date,"month start"==e?l=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0):"month end"==e?l=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999):"week start"==e?l=r(t):"week start monday"==e?l=r(t,!0):"week end monday"==e?l=n(t,!0):"week end"==e?l=n(t):"day start"==e?l=new Date(t.setHours(0,0,0,0)):"day end"==e&&(l=new Date(t.setHours(23,59,59,999))),l}function r(e,t){(e=e?new Date(+e):new Date).setHours(0,0,0,0),t=!!t;var r=e.getDay();return!0===t&&(0==r?r=6:r-=1),e.setDate(e.getDate()-r),e}function n(e,t){return e=r(e,t),e.getDay(),e.setDate(e.getDate()+6),new Date(e.setHours(23,59,59,999))}function l(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function i(e){if("number"==typeof e&&(e>0?e=!0:e<=0&&(e=!1)),"boolean"!=typeof e&&void 0!==e)throw"[camlsql] Value was not boolean";return void 0===e&&(e=!1),{type:"Boolean",value:e}}function s(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a number";return e=e||0,{type:"Number",value:e}}function a(e){var t=o(e);return t&&(t._includeTime=!1),t}function o(e){var t;return void 0!==e&&Z.isPrototypeOf(e)&&(e=e.value),"string"==typeof e?(t=e+"",e=null):e=e?new Date(+e):new Date,Object.create(Z,{type:{value:"DateTime"},value:{value:e,writable:!0},_includeTime:{value:!0,writable:!0},today:{value:!1,writable:!0},_storageTZ:{value:!1,writable:!0},stringValue:{value:t,writable:!1}})}function u(e,t){if(void 0===e&&(e=0),"number"!=typeof e)throw"[camlsql] Bad offset value for 'today'";return{type:"DateTime",today:!0,value:e,_includeTime:!0===t}}function c(e){if(void 0===e)throw"[camlsql] Missing parameter";return{type:"Guid",value:e}}function f(e,t){var r,n=["SPWeb.AllUsers","SPGroup","SPWeb.Groups","CurrentUserGroups","SPWeb.Users"],l=null;if(!e)throw"Membership type should be one of "+n.join(", ");for(r=0;r<n.length;r++)if(n[r].toLowerCase()==e.toLowerCase()&&(e=n[r],l=r,"SPGroup"===e&&"number"!=typeof t))throw"[camlsql] When using SPGroup you must specify a numeric GroupID";if(null===l)throw"Membership type should be one of "+n.join(", ");return{type:"Membership",value:e,id:t}}function d(e){return"number"==typeof e?{type:"User",value:e,lookupid:!0}:{type:"User"}}function m(e){function t(){var t=new SP.CamlQuery;t.set_datesInUtc(!1);var l=e.query.getXml(!0);t.set_viewXml(l),c=o.getItems(t),d&&console&&console.log("[camlsql] Executing SP.CamlQuery",l),n.load(c),n.executeQueryAsync(r,function(t,r){var n="";r&&-2130575340==r.get_errorCode()&&(n+=" (Error -2130575340: Check field names)"),a({status:"error",message:"Error executing the SP.CamlQuery"+n,data:{sql:e.query.$options.parsedQuery.query,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)})}function r(){var t,r,n,s,o,u=c.getEnumerator(),f=[],d=c.get_listItemCollectionPosition(),p={};for(d&&(l=d.get_pagingInfo());u.moveNext();){n=(t=u.get_current()).get_fieldValues(),i||(i="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(t.get_id()));var h=e.query.$options.parsedQuery.encoded,y=Object.keys(e.query.$options.parsedQuery.encoded);if(y.length>0)for(r=0;r<y.length;r++)void 0!==n[y[r]]&&(n[h[y[r]]]=n[y[r]]);m?void 0===p[o=null===n[s=m.field]?null:"object"==typeof n[s]&&void 0!==n[s].toString?"function"==typeof n[s].get_lookupValue?n[s].get_lookupValue():n[s].toString():n[s]]?(f.push({groupName:o,items:[n]}),p[o]=f.length-1):f[p[o]].items.push(n):f.push(n)}a(null,f,{nextPage:l,prevPage:i})}var n,l,i,s=e.spWeb,a=e.callback,o=null,u=e.query.getListName(),c=null,f=e&&e.rawXml?e.rawXml:e.query.getXml(!0),d=!1,m=e.query.$options.parsedQuery.group;if("function"!=typeof a&&(a=null),m&&e.query.$options.parsedQuery.fields.length>0&&-1===e.query.$options.parsedQuery.fields.indexOf(m.field))throw"[camlsql] The Grouping Field must be included in the field list";if(a||(d=!0,a=function(e,t){"undefined"!=typeof console&&(e&&console.error(e),void 0!==console.table?console.table(t):console.log("[camlsql] Result",t))}),"undefined"!=typeof SP)SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){}),SP.SOD.executeOrDelayUntilScriptLoaded(function(){n=SP.ClientContext.get_current(),null!==s&&"string"==typeof s&&(s=site.openWeb(s)),s||(s=n.get_web()),o=s.get_lists().getByTitle(u),d&&console&&console.log("[camlsql] Loading list '"+u+"'"),n.load(o),n.executeQueryAsync(t,function(){if(null==a)throw"[camlsql] Failed to load list";a({status:"error",message:"Failed to load list",data:{sql:e.query.$options.parsedQuery.query,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)})},"sp.js");else{if(d&&"undefined"!=typeof console&&console.log("[camlsql] ViewXML:",e.query.getXml(!0)),null==a)throw"[camlsql] SP is not defined";a({status:"error",message:"SP is not defined",data:null},null)}}function p(e,t){for(var r=String(e);r.length<(t||2);)r="0"+r;return r}function h(e){var t,r,n="";for(t=0;t<e.length;t++)0==(r=encodeURIComponent(e[t])).indexOf("%")?n+="_x"+("0000"+e.charCodeAt(t).toString(16)).slice(-4)+"_":n+="."==r?"_x002e_":"("==r?"_x0028_":")"==r?"_x0029_":r;return n.length>32?n.substr(0,32):n}function y(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function g(e){return e.replace(/^\s+|\s+$/g,"")}function _(e){return g(e).replace(/^[\[\(]|[\]\)]$/g,"")}function v(e){var t=0,r=0;if((e=g(e)).length>1&&"("==e[0]&&")"==e[e.length-1])for(t=0;t<e.length;t++)if("("==e[t])r++;else if(")"==e[t]){if(0==--r&&t==e.length-1)return v(e.substring(1,e.length-1));if(0==r)break}return e}function w(e,t){var r=this,n=b(t),l=null;this.spWeb=function(e){return l=e,this},this.exec=function(e){Array.prototype.slice.call(arguments);return m({query:this,callback:e,spWeb:l,rawXml:null}),this},this.getListName=function(){var e=r.$options.parsedQuery;return e.listName&&e.encoded[e.listName]?e.encoded[e.listName]:e.listName},this.getXml=function(e){return new $(r,e).xml},this.$options={parsedQuery:S(e),parameters:n}}function b(e){var t,r,n,l={};if(e&&e.length>0)for(t=0;t<e.length;t++)(r=q(e[t]))&&(l["@param"+t]=r);else if("object"==typeof e)for(n=Object.keys(e),t=0;t<n.length;t++)0===n[t].indexOf("@")&&(r=q(e[n[t]]))&&(l[n[t]]=r);return l}function q(e){var t,r=null;if(null==e)return null;if(null!==e&&e.constructor===Array)for(r=[],t=0;t<e.length;t++)r.push(q(e[t]));else if("string"==typeof e)r=l(e);else if("boolean"==typeof e)r=i(e);else if("number"==typeof e)r=s(e);else if("function"==typeof e.getMonth)r=o(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return r}function x(e,t){var r,n=e.query;new RegExp("([a-zA-Z_\\d]+?)(\\s|$)","ig");(r=n.match(/\sGROUP\sBY\s+([a-zA-Z_\d]+?)(\s+|$)/i))&&(e.query=n.substr(0,r.index)+" "+n.substr(r.index+r[0].length)+r[2],e.group={field:_(r[1]),collapse:!1})}function T(e){var t,r,n=e.query,l=[];do{if(r=n.match(/\s+(left\s+|)join\s+(.+?)\s+on\s+(.+?)(\s|$)/i)){if(-1===r[3].indexOf("."))throw"[camlsql] You must specify the List Name when joining: JOIN [ListAlias] ON [List].[Field]";if(!(t=r[3].split("."))[0].match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap list alias in brackets if it contains special characters: "+t[0];if(!r[2].match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap list alias in brackets if it contains special characters: "+r[2];l.push({inner:""==g(r[1]),alias:_(r[2]),childTable:t[0],childField:t[1]}),n=n.substr(0,r.index)+" "+n.substr(r.index+r[0].length)+r[4]}}while(r);e.joins=l,e.query=n}function k(e){var t;if(t=e.query.match(/\sLIMIT\s+(.*?)(\s.*$|$)/i)){if(!t[1].match(/^\d+$/))throw"[camlsql] LIMIT value must be a number";if("0"==t[1])throw"[camlsql] LIMIT value can not be 0";e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10)}}function D(e){var t,r,n=[],l=e.query.match(/^SELECT\s(.*?)(?:\sFROM\s(.*?)|)(?:\s+((?:order|group|where).*)$|$)/i);if(l&&4==l.length){for(n=L(l[1]),r=0;r<n.length;r++)if(t=n[r].match(/^(.*?)\.(.*?)\sas\s(.*?)$/i))e.projectedFields.push({list:t[1],field:t[2],name:t[3]}),n[r]=_(t[3]);else if(-1!==n[r].indexOf("."))throw"[camlsql] Projected fields in the format <list>.<field_name> must be followed with an AS <alias>";if(e.fields=n,e.listName=_(l[2]),!e.listName.match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap list name in brackets if it contains special characters: ["+e.listName+"]";e.query=l[3]}}function L(e){var t,r=[],n=e.split(",");for(t=0;t<n.length;t++)n[t]=_(n[t]),r.push(n[t]);return 1==r.length&&"*"==r[0]&&(r=[]),r}function O(e,t){var r,n,l,i,s,a,o=[],u=e.query,c=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(a=u.match(/\sORDER\sBY\s+(.*?)$/i)){if(i=a[1],u=u.substr(0,u.length-a[0].length),void 0!==i&&null!==i)for(;r=c.exec(i);){if(s=!0,l=null,r[1].indexOf(":")>0){if(2==(a=r[1].split(":")).length&&a[0].length>0){switch(a[0]=a[0].toLowerCase(),a[0]){case"datetime":a[0]="DateTime";break;case"text":a[0]="Text";break;case"number":a[0]="Number"}l=a[0],r[1]=a[1]}}else if(!r[1].match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap order by field name in brackets if it contains special characters";n=_(r[1]),3==r.length&&(s="desc"!=(void 0!==r[2]?g(r[2].toLowerCase()):null)),o.push([n,s,l])}e.sort=o}}function P(e){var t,r,n=e.query;if(t=n.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":r="DefaultValue";break;case"recursive":r="Recursive";break;case"recursiveall":r="RecursiveAll";break;case"filesonly":r="FilesOnly"}if(!r&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==r&&(e.viewScope=r),e.query=t[1]+n.substr(t[1].length+t[2].length)}else e.viewScope=null}function S(e,t){var r,n={query:e,rowLimit:0,fields:[],sort:[],joins:[],viewScope:null,macros:[],statements:[],parameters:[],listName:null,projectedFields:[],group:null,encoded:{}};return N(n),P(n),k(n),O(n),x(n),T(n),D(n),r=X(n.query),n.statements=r.statements,n.macros=r.macros,n.query=e,n}function N(e){var t,r,n,l=e.query,i=0,s=null,a=l;for(t=0;t<l.length;t++)"["==l[t]?(i++,null===s&&(s=t)):"]"==l[t]&&0==--i&&(n=h((r=l.substring(s,t+1)).substring(1,r.length-1)),a=a.replace(r,n),s=null,e.encoded[n]=r.substring(1,r.length-1));e.query=a}function $(e,t){var r="",n=e.$options.parsedQuery,l=e.$options.parameters,i=0;return n.uuid=function(e){return i++,e+i},r+=A(n,n.statements,n.sort,l,t,{errors:[]}),r+=F(n,n.listName,n.joins),r+=j(n.projectedFields,n.joins),r+=Q(n.fields),(r+=C(n.rowLimit))&&(r=G(Y,{Scope:n.viewScope})+r+z("View")),{xml:r,errors:null}}function I(e){var t="";return e.group&&(t+=G("GroupBy",{Collapse:e.group.collapse?"True":null}),t+=G("FieldRef",{Name:e.group.field},!0),t+=z("GroupBy")),t}function C(e){var t="";return e>0&&(t+=G("RowLimit"),t+=e,t+=z("RowLimit")),t}function j(e,t){var r,n="",l=[];if(e.length>0&&t.length>0){for(n+=G("ProjectedFields"),r=0;r<t.length;r++)l.push(t[r].alias);for(r=0;r<e.length;r++){if(-1==l.indexOf(e[r].list))throw"[camlsql] Uknown list alias: "+e[r].list;n+=G("Field",{Name:e[r].name,List:e[r].list,Type:"Lookup",ShowField:e[r].field},!0)}n+=z("ProjectedFields")}else if(e.length>0&&0==t.length)throw"[camlsql] You must JOIN another list to use projected fields";return n}function F(e,t,r){var n,l,i="";if(r.length>0){for(i+=G("Joins"),n=0;n<r.length;n++)i+=G("Join",{ListAlias:r[n].alias}),l=r[n].childTable,i+=G("Eq"),i+=G("FieldRef",{List:r[n].childTable!=t?l:null,Name:r[n].childField,RefType:"Id"},!0),i+=G("FieldRef",{List:r[n].alias,Name:"Id"},!0),i+=z("Eq"),i+=z("Join");i+=z("Joins")}return i}function V(e){var t="";if(e.length>0){t+=G(ee);for(var r=0;r<e.length;r++)t+=G(J,{Name:e[r][0],Type:e[r][2]?e[r][2]:null,Ascending:e[r][1]?null:"False"},!0);t+=z(ee)}return t}function A(e,t,r,n,l,i){var s="";return(t.length>0||r.length>0||e.group&&!l)&&(s+=G(K),t.length>0&&(s+=G(te),s+=R(e,t,n,i),s+=z(te)),s+=V(r,n,i),l||(s+=I(e)),s+=z(K)),s}function R(e,t,r,n){var l="";if(!t)return"";if(t.length>1){var i="and"==t[1].operator?"And":"Or";return l+=M(e,t[0],r,n),l+=R(e,t.slice(1),r,n),"<"+i+">"+l+"</"+i+">"}return 1==t.length&&(l+=M(e,t[0],r,n)),l}function M(e,t,r,n){var l,i,s="",a=t.comparison;if("statement"==t.type){l=r[t.macro];var o={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"Lt",ne:"Neq"};if(void 0!==o[a]){if(void 0===l)throw"[camlsql] Parameter is not defined "+t.macro;if(l&&"Membership"==l.type){if("eq"!=t.comparison)throw"[camlsql] Membership comparison must be =";s+=G("Membership",{Type:l.value,ID:l.id?l.id:null}),s+=G(J,{Name:t.field},!0),s+=z("Membership")}else s+=G(o[a]),s+=E(e,t,l),s+=z(o[a])}else if("null"==a)s+=G(re),s+=E(e,t),s+=z(re);else if("in"==a)s+=G("In"),s+=E(e,t,l),s+=z("In");else if("notnull"==a)s+=G(ne),s+=E(e,t),s+=z(ne);else if("like"==a){var u=W(l.value);i=u[1],l.overrideValue=u[0],s+=G(i),s+=E(e,t,l),s+=z(i)}}else s+=R(e,t.items,r,n);return s}function W(e){var t="Contains",r=e;if(!e)return[e,t];if(0===e.indexOf("%")&&"%"===e[e.length-1])r=e.replace(/^%?|%?$/g,"");else{if(0===e.indexOf("%"))throw"[camlsql] SharePoint does not support an 'EndsWith' statement: "+e;e.indexOf("%")===e.length-1&&(r=e.replace(/%?$/,""),t="BeginsWith")}return[r,t]}function E(e,t,r,n){var l,i="",s=null,a=t.field;if(r&&r.lookupid&&(s="True"),-1!==t.field.indexOf(".")){var o=t.field.split("."),u=!0,c=!0;if(_(o[0])==e.listName)a=o[1];else{for(l=0;l<e.projectedFields.length;l++)e.projectedFields[l].list==_(o[0])&&e.projectedFields[l].field==_(o[1])&&(a=e.projectedFields[l].name,u=!1);if(u){for(l=0;l<e.joins.length;l++)if(e.joins[l].alias==o[0]){c=!1;break}if(c)throw"[camlsql] Unknown list alias in where clause: "+o[0];if(0==e.fields.length)throw"[camlsql] The projected field '"+t.field+"' must be explicitly included in the query";a=e.uuid("camlsqlfld_"),e.projectedFields.push({list:o[0],field:o[1],name:a}),e.fields.push(a)}}}if(i+=G(J,{Name:a,LookupId:s},!0),r)if("in"==t.comparison){if(!r||r.constructor!==Array)throw"[camlsql] IN parameter must be an array";for(i+="<Values>",l=0;l<r.length;l++)i+=U(t,r[l],r[l].value);i+="</Values>"}else i+=U(t,r);return i}function U(e,t){var r="",n="",l={},i={Type:t.type},s=t.overrideValue?t.overrideValue:t.value;if("DateTime"==t.type)i.IncludeTimeValue=t._includeTime?"True":null,t.value&&(l.Offset=s),!0===t.today?n=G("Today",l,!0):(i.StorageTZ=t._storageTZ?"True":null,n=t.stringValue?y(t.stringValue):t._storageTZ?s.toISOString():s.getFullYear()+"-"+p(s.getMonth()+1)+"-"+p(s.getDate())+"T"+p(s.getHours())+":"+p(s.getMinutes())+":"+p(s.getSeconds()));else if("Text"==t.type)n=1==t.multiline?"<![CDATA["+y(s)+"]]>":y(s);else if("Number"==t.type||"Guid"==t.type)n=s;else if("User"==t.type)"number"==typeof s?(i.Type="User",n=y(s+"")):(i.Type="Number",n="<UserID />");else if("Lookup"==t.type)1==t.byId&&(i.LookupId="True"),n=y(s+"");else{if("Boolean"!=t.type)throw"[camlsql] Parameter type is not not implemented "+t.type;n=s?1:0}return r+=G("Value",i),r+=n,r+=z("Value")}function Q(e){var t,r="";if(e.length>0){for(r+=G(H),t=0;t<e.length;t++){if(!e[t].match(/^[a-zA-Z_\d]+$/i))throw"[camlsql] Invalid syntax: "+e[t];r+=G(J,{Name:e[t]},!0)}r+=z(H)}return r}function G(e,t,r){var n,l="<"+e,i=t?Object.keys(t):[];for(n=0;n<i.length;n++)void 0!==t[i[n]]&&null!==t[i[n]]&&(l+=" "+i[n]+'="'+y(t[i[n]])+'"');return l+(r?" /":"")+">"}function z(e){return"</"+e+">"}var B,Z={type:"DateTime",today:!1,_includeTime:!1,value:null,_storageTZ:!1,stringValue:"",add:function(t){this.errstr();var r=e(t);return this.value=new Date(this.value.getTime()+r),this.today=!1,this},sub:function(t){this.errstr();var r=e(t);return this.value=new Date(this.value.getTime()-r),this.today=!1,this},startOfWeek:function(e){return this.errstr(),this.value=t("week start"+(e?"":" monday"),this.value),this.today=!1,this},endOfWeek:function(e){return this.errstr(),this.value=t("week end"+(e?"":" monday"),this.value),this.today=!1,this},startOfMonth:function(){return this.errstr(),this.value=t("month start",this.value),this.today=!1,this},endOfMonth:function(){return this.errstr(),this.value=t("month end",this.value),this.today=!1,this},endOfDay:function(){return this.errstr(),this.value=t("day end",this.value),this.today=!1,this},startOfDay:function(){return this.errstr(),this.value=t("day start",this.value),this.today=!1,this},storageTZ:function(e){return this._storageTZ=!!e,this.today=!1,this},includeTime:function(e){return this._includeTime=!!e,this},errstr:function(){if(this.stringValue)throw"[camlsql] You can't do that when DateTime was set as a string"}},X=function(e,t){function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e,a){var o,u,c,f,d,m,p,h,y,g=null,w=null,b=[],q=0,x=null;for(e=v(e),a=a||0,o=0;o<e.length;o++)e[o]==i?(0==q&&(o>0&&0==b.length?b.push(e.substring(0,o)):null!=x&&b.push(e.substring(x,o)),g=o,w=null),q++):e[o]==s&&null!==g&&0==--q&&(g,b.push(r(e.substring(g,o+1)).replace(/^\(|\)$/g,"")),w=o+1,x=o+1,g=null);for(null!=w&&null==g?r(e.substring(w))&&b.push(r(e.substring(w))):null!=g||0==b.length&&null==g&&null==w&&b.push(r(e)),o=0;o<b.length;o++)if(u="and",b[o].match(/^\s*(\|\||(or))\s*/i)&&(u="or"),b[o].match(/\s*(?:\|\||(or))\s*$/gi)&&o<b.length-1&&(b[o+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(b[o+1]="or "+b[o+1])),b[o]=b[o].replace(/\s*(\&\&|and)\s*$/i,""),b[o]=b[o].replace(/\s*(\|\||or)\s*$/i,""),b[o]=b[o].replace(/^\s*(\&\&|and)\s*/i,""),b[o]=b[o].replace(/^\s*(\|\||or)\s*/i,""),b[o]={type:"statement",value:b[o],operator:u},b[o].value.indexOf(i)>0)(f=n(b[o].value,a+1)).length>1&&(b[o].type="group",b[o].items=f);else{for(c=b[o].value.split(/ (\|\||or|and|\&\&) /i),b[o].type="statement",d=[],m=0;m<c.length;m++)if(p={type:"statement",operator:"and"},""!=r(c[m])&&"and"!=c[m].toLowerCase()&&"or"!=c[m].toLowerCase()&&"||"!=c[m]&&"&&"!=c[m])if(m>0&&("or"!=c[m-1].toLowerCase()&&"||"!=c[m-1]||(p.operator="or")),h=l(c[m]))p.field=_(h.field),p.macro=h.macro,p.comparison=h.comparison,d.push(p);else if(!t)throw"[camlsql] Could not parse statement: "+c[m];d.length>1?(b[o].type="group",b[o].items=d):1==d.length&&(b[o].field=_(d[0].field),b[o].macro=d[0].macro,b[o].comparison=d[0].comparison)}for(y=[],o=0;o<b.length;o++)b[o].value&&y.push(b[o]);return y}function l(e){if(void 0===e)return null;var t=(e=(e=e.replace(/ is\s+not\s+null/i," cxqlisnotnull ?")).replace(/ is\s+null/i," cxqlisnull ?")).match(/([a-zA-Z_\d\.]+)\s*(<>|>=|[^<]>|<=|<[^>]|=|\slike|\scxqlisnull|\scxqlisnotnull|in)\s*(\?|@[a-z0-9_]+)/i);if(t){var n="eq",l="@param"+u,i=r(t[2]);if(">"==i&&(n="gt"),">="==i&&(n="gte"),"<"==i&&(n="lt"),"<="==i&&(n="lte"),"=="==i&&(n="eq"),"<>"!=i&&"!="!=i||(n="ne"),"like"==i.toLowerCase()&&(n="like"),"cxqlisnull"==i.toLowerCase()&&(n="null"),"cxqlisnotnull"==i.toLowerCase()&&(n="notnull"),"in"==i.toLowerCase()&&(n="in"),"null"!=n&&"notnull"!=n){if(u++,c++,null==a)a=t[3][0];else if(a!=t[3][0])throw"[camlsql] You can not mix named macros and ?";"@"==t[3][0]&&(l=t[3]),f.push(l)}else l=null;return{field:_(t[1]),comparison:n,macro:l}}return null}var i="(",s=")",a=null,o={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return o;var u=0,c=0,f=[],d=n(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==d&&(o.statements=d),o.macroType=a,o.macroCount=c,o.macros=f,o},Y="View",H="ViewFields",J="FieldRef",K="Query",ee="OrderBy",te="Where",re="IsNull",ne="IsNotNull";return B={prepare:function(e,t){return new w(e,t)},boolean:i,date:a,datetime:o,encode:h,membership:f,lookup:function(e){if("string"!=typeof e&&"number"!=typeof e)throw"[camlsql] Value must be number or string";return{type:"Lookup",value:e,lookupid:"number"==typeof e,byId:"number"==typeof e}},number:s,guid:c,text:l,today:u,user:d},B.__testonly__=B.__testonly__||{},B.__testonly__.padString=p,B.__testonly__.extractOrderByPart=O,B.__testonly__.extractListAndFieldNameParts=D,B.__testonly__.extractScopePart=P,B.__testonly__.extractLimitPart=k,B.__testonly__.parseSqlQuery=S,B.__testonly__.whereParser=X,B.__testonly__.createDateParameter=a,B.__testonly__.createDateTimeParameter=o,B.__testonly__.createTodayParameter=u,B.__testonly__.createGuidParameter=c,B.__testonly__.createUserParameter=d,B.__testonly__.encodeHTML=y,B.__testonly__.trim=g,B.__testonly__.formatFieldName=_,B.__testonly__.getIntervalStringAsMs=e,B.__testonly__.createDateWithIntervalString=function(t){var r=e(t);return new Date((new Date).getTime()+r)},B.__testonly__.getDateFromTextualRepresentation=t,B.__testonly__.getStartOfWeek=r,B.__testonly__.getEndOfWeek=n,B.__testonly__.executeSPQuery=m,B.__testonly__.trimParanthesis=v,B.__testonly__.extractNamesToEncode=N,B.__testonly__.createMembershipParameter=f,B});