/*! camlsqj-js v1.0.1 | (c) dlid.se | https://camlsqljs.dlid.se/license */
!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.camlsql=t()}(this,function(){"use strict";function e(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e&&null!=e&&"string"==typeof e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function t(e){var t;return"string"==typeof e&&("month start"==e?(new Date,e=d.getFullYear()+"-"+r(d.getMonth()+1)+"-01T00:00:00Z"):"month end"==e?(new Date,e=(t=new Date(d.getFullYear(),d.getMonth()+1,0)).getFullYear()+"-"+r(t.getMonth()+1)+"-"+r(t.getDate())+"T23:59:59Z"):"this morning"==e?(new Date,e=d.getFullYear()+"-"+r(d.getMonth()+1)+"-"+r(d.getDate())+"T00:00:00Z"):"tonight"==e&&(new Date,e=d.getFullYear()+"-"+r(d.getMonth()+1)+"-"+r(d.getDate())+"T23:59:59Z")),"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e,includeTime:!0}:(console.error("[camlsql] Bad format for datetime value"),null)}function n(e){function t(){var e=new SP.CamlQuery,t=f;e.set_viewXml(t),console.log("camlQuery",e),c=s.getItems(e),r.load(c),r.executeQueryAsync(n,function(){a({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:getSql,viewXml:f,listName:i,error:Array.prototype.slice.call(arguments)}},null)})}function n(){var e,t=c.getEnumerator(),n=[],r=c.get_listItemCollectionPosition();for(r&&(l=r.get_pagingInfo());t.moveNext();)e=t.get_current(),o||(o="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id())),n.push(e.get_fieldValues());a(null,n,{nextPage:l,prevPage:o})}var r,l,o,u=e.spWeb,a=e.callback,s=null,i=e.query.getListName(),c=null,f=e.query.getXml();return"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){r=SP.ClientContext.get_current(),null===u&&(u=r.get_web(),s=u.get_lists().getByTitle(i),r.load(s),r.executeQueryAsync(t,function(){a({status:"error",message:"Failed to load list",data:{sql:getSql,viewXml:f,listName:i,error:Array.prototype.slice.call(arguments)}},null)}))}):a({status:"error",message:"SP is not defined",data:null},null),console.log({web:u,callback:a}),publicItems}function r(e,t){for(var n=String(e);n.length<(t||2);)n="0"+n;return n}function l(e){return e.replace(/^\s+|\s+$/g,"")}function o(e){return l(e).replace(/^\[|\]$/g,"")}function u(e,t){var r=this,l=a(t);console.log("parameters",l),this.exec=function(){var e,t,r=Array.prototype.slice.call(arguments);return r.length>1?"object"==typeof r[0]&&(e=r[0],"function"==typeof r[1]&&(t=r[1])):1==r.length&&("object"==typeof r[0]?e=r[0]:"function"==typeof r[0]&&(t=r[0])),n({query:this,callback:t,spWeb:e})},this.getXml=function(){return new h(r)},this.$options={parsedQuery:g(e)}}function a(e){var t,n,r={};if(e&&e.length>0)for(t=0;t<e.length;t++)(n=s(e[t]))&&(r["@param"+t]=n);return r}function s(t){var n,r=null;if(null==t)return null;if(null!==t&&t.constructor===Array)for(r=[],n=0;n<t.length;n++)r.push(s(t[n]));else if("string"==typeof t)r=e(t);else if("number"==typeof t)r=camlsql.number(t);else if("object"==typeof t&&"undefined"!==t.type)return t;return r}function i(e){var t;(t=e.query.match(/\sLIMIT\s(\d+).*$/i))&&(e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10))}function c(e){var t,n=[],r=e.query.match(/^SELECT\s(.*?)\sFROM\s(.*?)(?:\s+(where.*)$|$)/i);if(r)if(4==r.length){for(n=f(r[1]),t=0;t<n.length;t++)n[t].match(/^[a-z:A-Z_\\d]+$/)||console.warn&&console.warn("[camlsql] Doubtful field name: "+n[t]);e.fields=n,o(r[2]),e.query=r[3]}else e.query=""}function f(e){var t,n=[],r=e.split(",");for(t=0;t<r.length;t++)r[t]=o(r[t]),n.push(r[t]);return 1==n.length&&"*"==n[0]&&(n=[]),n}function m(e,t){var n,r,u,a,s,i,c=[],f=e.query,m=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(i=f.match(/\sORDER\sBY\s(.*?)$/i)){if(a=i[1],f=f.substr(0,f.length-i[0].length),void 0!==a&&null!==a)for(;n=m.exec(a);){if(s=!0,u=null,n[1].indexOf(":")>0){if(!(2==(i=n[1].split(":")).length&&i[0].length>0))return[];switch(i[0]=i[0].toLowerCase(),i[0]){case"datetime":i[0]="DateTime";break;case"text":i[0]="Text";break;case"number":i[0]="Number";break;case"datetime":i[0]="DateTime"}u=i[0],n[1]=i[1]}else console.error&&console.error("[camlsql] Error in ORDER BY statement: "+n[1]);r=o(n[1]),3==n.length&&(s="desc"!=(void 0!==n[2]?l(n[2].toLowerCase()):null)),c.push([r,s,u])}e.sort=c}}function p(e){var t,n,r=e.query;if(t=r.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":n="DefaultValue";break;case"recursive":n="Recursive";break;case"recursiveall":n="RecursiveAll";break;case"filesonly":n="FilesOnly"}if(!n&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==n&&(e.viewScope=n),e.query=t[1]+r.substr(t[1].length+t[2].length)}else e.viewScope=null}function g(e,t){var n,r={query:e,rowLimit:0,fields:[],sort:[],viewScope:null,macros:[],statements:[]};return p(r),i(r),m(r),c(r),n=y(r.query),r.statements=n.statements,r.macros=n.macros,r.query=e,r}function h(){return{xml:null,errors:null}}var y=function(e,t){function n(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){var o,s,i,c,f,m,d,p,g,h=null,y=null,v=[],w=0;for(o=0;o<e.length;o++)e[o]==u?(0==w&&(o>0&&v.push(e.substring(0,o)),h=o,y=null),w++):e[o]==a&&null!==h&&0==--w&&(v.push(n(e.substring(h,o+1)).replace(/^\(|\)$/g,"")),y=o+1);for(null!=y?v.push(n(e.substring(y))):0==v.length&&null==h&&null==y&&v.push(n(e)),o=0;o<v.length;o++)if(s="and",v[o].match(/^\s*(\|\||(or))\s*/i)&&(s="or"),v[o].match(/\s*(?:\|\||(or))\s*$/gi)&&o<v.length-1&&(v[o+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(v[o+1]="or "+v[o+1])),v[o]=v[o].replace(/\s*(\&\&|and)\s*$/i,""),v[o]=v[o].replace(/\s*(\|\||or)\s*$/i,""),v[o]=v[o].replace(/^\s*(\&\&|and)\s*/i,""),v[o]=v[o].replace(/^\s*(\|\||or)\s*/i,""),v[o]={type:"statement",value:v[o],operator:s},-1!==v[o].value.indexOf(u))(c=r(v[o].value)).length>1&&(v[o].type="group",v[o].items=c);else{for(i=v[o].value.split(/ (\|\||or|and|\&\&) /i),v[o].type="statement",f=[],m=0;m<i.length;m++)if(d={type:"statement",operator:"and"},""!=n(i[m])&&"and"!=i[m].toLowerCase()&&"or"!=i[m].toLowerCase()&&"||"!=i[m]&&"&&"!=i[m])if(m>0&&("or"!=i[m-1].toLowerCase()&&"||"!=i[m-1]||(d.operator="or")),p=l(i[m]))d.field=p.field,d.macro=p.macro,d.comparison=p.comparison,f.push(d);else if(!t)throw"[casql] Could not parse statement: "+i[m];f.length>1?(v[o].type="group",v[o].items=f):1==f.length&&(v[o].field=f[0].field,v[o].macro=f[0].macro,v[o].comparison=f[0].comparison)}for(g=[],o=0;o<v.length;o++)v[o].value&&g.push(v[o]);return g}function l(e){if(void 0===e)return null;var r=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(r){var l="eq",u="@param"+c,a=n(r[2]);if(">"==a&&(l="gt"),">="==a&&(l="gte"),"<"==a&&(l="lt"),"<="==a&&(l="lte"),"=="==a&&(l="eq"),"<>"!=a&&"!="!=a||(l="ne"),"like"==a.toLowerCase()&&(l="like"),"isnull"==a.toLowerCase()&&(l="null"),"isnotnull"==a.toLowerCase()&&(l="notnull"),"in"==a.toLowerCase()&&(l="in"),"null"!=l&&"notnull"!=l){if(c++,f++,null==s)s=r[3];else if(s!=r[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==r[3][0]&&(u=r[3]),m.push(u)}else u=null;return{field:o(r[1]),comparison:l,macro:u}}return null}var u="(",a=")",s=null,i={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return i;var c=0,f=0,m=[],d=r(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==d&&(i.statements=d),i.macroType=s,i.macroCount=f,i.macros=m,i};return{prepare:function(e,t){return new u(e,t)},text:e,guid:function(e){return{type:"Guid",value:e}},number:function(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] value was not a number";return e=e||0,{type:"Number",value:e}},lookup:function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},now:function(e){return{type:"DateTime",isNow:!0,includeTime:1==e}},date:function(e){var n=t(e);return n&&(n.includeTime=!1),n},datetime:t,today:function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},multichoice:function(e){return{type:"MultiChoice",value:e}},choice:function(e){return{type:"Choice",value:e}},url:function(e){return{type:"URL",value:e}},user:function(e){return{type:"User",value:e}}}});