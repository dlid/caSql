/*! camlsqj-js v0.0.1 | (c) dlid.se | https://camlsqljs.dlid.se/license */
!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():e.camlsql=t()}(this,function(){"use strict";function e(e){var t,n=0;if("string"!=typeof e)throw"[camlsql] Interval value must be a string";if(e=e.toLowerCase(),t=e.match(/^(\d+) (day|hour|minute|second|ms|millisecond)s?$/i)){switch(e=parseInt(e,10),t[2]){case"day":n=24*e*60*60;break;case"hour":n=60*e*60;break;case"minute":n=60*e;break;case"second":n=e;break;case"ms":case"millisecond":n=e/1e3}return 1e3*n}throw"[camlsql] Interval string was not recognized: "+e}function t(e,t){var l;return e=p(e.toLowerCase()),t=t?new Date(+t):new Date,"month start"==e?l=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0):"month end"==e?l=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999):"week start"==e?l=n(t):"week start monday"==e?l=n(t,!0):"week end monday"==e?l=r(t,!0):"week end"==e?l=r(t):"day start"==e?l=new Date(t.setHours(0,0,0,0)):"day end"==e&&(l=new Date(t.setHours(23,59,59,999))),l}function n(e,t){(e=e?new Date(+e):new Date).setHours(0,0,0,0),t=!!t;var n=e.getDay();return!0===t&&(0==n?n=6:n-=1),e.setDate(e.getDate()-n),e}function r(e,t){return e=n(e,t),e.getDay(),e.setDate(e.getDate()+6),new Date(e.setHours(23,59,59,999))}function l(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function i(e){if("number"==typeof e&&(e>0?e=!0:e<=0&&(e=!1)),"boolean"!=typeof e&&void 0!==e)throw"[camlsql] Value was not boolean";return void 0===e&&(e=!1),{type:"Boolean",value:e}}function s(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a number";return e=e||0,{type:"Number",value:e}}function o(e){var t;return void 0!==e&&Z.isPrototypeOf(e)&&(e=e.value),"string"==typeof e?(t=e+"",e=null):e=e?new Date(+e):new Date,Object.create(Z,{type:{value:"DateTime"},value:{value:e,writable:!0},_includeTime:{value:!0,writable:!0},today:{value:!1,writable:!0},_storageTZ:{value:!1,writable:!0},stringValue:{value:t,writable:!1}})}function a(e){function t(){var t=new SP.CamlQuery;t.set_datesInUtc(!1);var l=e.query.getXml(!0);t.set_viewXml(l),d=a.getItems(t),h&&console&&console.log("[camlsql] Executing SP.CamlQuery",l),r.load(d),r.executeQueryAsync(n,function(t,n){var r="";n&&-2130575340==n.get_errorCode()&&(r+=" (Error -2130575340: Check field names)"),o({status:"error",message:"Error executing the SP.CamlQuery"+r,data:{sql:e.query.$options.parsedQuery.query,viewXml:m,listName:f,error:Array.prototype.slice.call(arguments)}},null)})}function n(){var e,t,n,r,s=d.getEnumerator(),a=[],u=d.get_listItemCollectionPosition(),f={};u&&(l=u.get_pagingInfo());var p=c.get_information(),m=p.get_bias()/60;for(console.log("TIMEZONE offset",p.get_bias(),p.get_daylightBias(),m);s.moveNext();){t=(e=s.get_current()).get_fieldValues(),i||(i="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id()));for(var h in t)if(t[h]&&"function"==typeof t[h].getTimezoneOffset&&"DateTime_x0020_field"==h){var y=new Date(t[h].getTime()-3600*m*1e3);console.log(h,"is a date",t[h],t[h].getUTCFullYear(),t[h].getUTCMonth(),t[h].getUTCDate(),t[h].getUTCHours(),t[h].getUTCMinutes(),t[h].getUTCSeconds()),console.log(y,"is a date2",y,y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate(),y.getUTCHours(),y.getUTCMinutes(),y.getUTCSeconds())}g?void 0===f[r=null===t[n=g.field]?null:"object"==typeof t[n]&&void 0!==t[n].toString?"function"==typeof t[n].get_lookupValue?t[n].get_lookupValue():t[n].toString():t[n]]?(a.push({groupName:r,items:[t]}),f[r]=a.length-1):a[f[r]].items.push(t):a.push(t)}o(null,a,{nextPage:l,prevPage:i})}var r,l,i,s=e.spWeb,o=e.callback,a=null,c=null,f=e.query.getListName(),d=null,p=null,m=e&&e.rawXml?e.rawXml:e.query.getXml(!0),h=!1,g=e.query.$options.parsedQuery.group;if("function"!=typeof o&&(o=null),g&&e.query.$options.parsedQuery.fields.length>0&&-1===e.query.$options.parsedQuery.fields.indexOf(g.field))throw"[camlsql] The Grouping Field must be included in the field list";if(o||(h=!0,o=function(e,t){"undefined"!=typeof console&&(e&&console.error(e),void 0!==console.table?console.table(t):console.log("[camlsql] Result",t))}),"undefined"!=typeof SP)SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){}),SP.SOD.executeOrDelayUntilScriptLoaded(function(){console.warn("GET SERVER TIMEZOE",_spPageContextInfo.webServerRelativeUrl+"/_api/web/RegionalSettings/TimeZone"),u(_spPageContextInfo.webServerRelativeUrl+"/_api/web/RegionalSettings/TimeZone",function(e,t){console.warn("TZ INFO",e,t)}),r=SP.ClientContext.get_current(),s||(s=r.get_web(),p=s.get_regionalSettings(),a=s.get_lists().getByTitle(f),c=p.get_timeZone(),h&&console&&console.log("[camlsql] Loading list '"+f+"'"),r.load(a),r.load(p),r.load(c),r.executeQueryAsync(t,function(){if(null==o)throw"[camlsql] Failed to load list";o({status:"error",message:"Failed to load list",data:{sql:e.query.$options.parsedQuery.query,viewXml:m,listName:f,error:Array.prototype.slice.call(arguments)}},null)}))},"sp.js");else{if(h&&"undefined"!=typeof console&&console.log("[camlsql] ViewXML:",e.query.getXml(!0)),null==o)throw"[camlsql] SP is not defined";o({status:"error",message:"SP is not defined",data:null},null)}}function u(e,t){var n=new XMLHttpRequest;n.open("GET",e),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Accept","application/json; odata=verbose"),n.onload=function(){200===n.status?t(null,n.responseText):t(n,null)},n.send()}function c(e,t){for(var n=String(e);n.length<(t||2);)n="0"+n;return n}function f(e){var t,n,r="";for(t=0;t<e.length;t++)0==(n=encodeURIComponent(e[t])).indexOf("%")?r+="_x"+("0000"+e.charCodeAt(t).toString(16)).slice(-4)+"_":r+=" "==n?"_x0020_":"."==n?"_x002e_":"("==n?"_x0028_":")"==n?"_x0029_":n;return r.length>32?r.substr(0,32):r}function d(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function p(e){return e.replace(/^\s+|\s+$/g,"")}function m(e){return p(e).replace(/^[\[\(]|[\]\)]$/g,"")}function h(e){var t=0,n=0;if((e=p(e)).length>1&&"("==e[0]&&")"==e[e.length-1])for(t=0;t<e.length;t++)if("("==e[t])n++;else if(")"==e[t]){if(0==--n&&t==e.length-1)return h(e.substring(1,e.length-1));if(0==n)break}return e}function g(e,t){var n=this,r=y(t);this.exec=function(e){var t,n,r=Array.prototype.slice.call(arguments),l=void 0!==e?e.rawXml:null;return r.length>1?"object"==typeof r[0]&&(t=r[0],"function"==typeof r[1]&&(n=r[1])):1==r.length&&("object"==typeof r[0]?t=r[0]:"function"==typeof r[0]&&(n=r[0])),a({query:this,callback:n,spWeb:t,rawXml:l}),this},this.getListName=function(){var e=n.$options.parsedQuery;return e.listName&&e.encoded[e.listName]?e.encoded[e.listName]:e.listName},this.getXml=function(e){return new D(n,e).xml},this.$options={parsedQuery:k(e),parameters:r}}function y(e){var t,n,r={};if(e&&e.length>0)for(l=0;l<e.length;l++)(t=v(e[l]))&&(r["@param"+l]=t);else if("object"==typeof e){n=Object.keys(e);for(var l=0;l<n.length;l++)0===n[l].indexOf("@")&&(t=v(e[n[l]]))&&(r[n[l]]=t)}return r}function v(e){var t,n=null;if(null==e)return null;if(null!==e&&e.constructor===Array)for(n=[],t=0;t<e.length;t++)n.push(v(e[t]));else if("string"==typeof e)n=l(e);else if("boolean"==typeof e)n=i(e);else if("number"==typeof e)n=s(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return n}function w(e,t){var n,r=e.query;new RegExp("([a-zA-Z_\\d]+?)(\\s|$)","ig");(n=r.match(/\sGROUP\sBY\s+([a-zA-Z_\d]+?)(\s+|$)/i))&&(e.query=r.substr(0,n.index)+" "+r.substr(n.index+n[0].length)+n[2],e.group={field:m(n[1]),collapse:!1})}function b(e){var t,n,r=e.query,l=[];do{if(n=r.match(/\s+(left\s+|)join\s+(.+?)\s+on\s+(.+?)(\s|$)/i)){if(-1===n[3].indexOf("."))throw"[camlsql] You must specify the List Name when joining: JOIN [ListAlias] ON [List].[Field]";if(!(t=n[3].split("."))[0].match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap list alias in brackets if it contains special characters: "+t[0];if(!n[2].match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap list alias in brackets if it contains special characters: "+n[2];l.push({inner:""==p(n[1]),alias:m(n[2]),childTable:t[0],childField:t[1]}),r=r.substr(0,n.index)+" "+r.substr(n.index+n[0].length)+n[4]}}while(n);e.joins=l,e.query=r}function q(e){var t;if(t=e.query.match(/\sLIMIT\s+(.*?)(\s.*$|$)/i)){if(!t[1].match(/^\d+$/))throw"[camlsql] LIMIT value must be a number";if("0"==t[1])throw"[camlsql] LIMIT value can not be 0";e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10)}}function T(e){var t,n,r=[],l=e.query.match(/^SELECT\s(.*?)(?:\sFROM\s(.*?)|)(?:\s+((?:order|group|where).*)$|$)/i);if(l)if(4==l.length){for(r=x(l[1]),n=0;n<r.length;n++)if(t=r[n].match(/^(.*?)\.(.*?)\sas\s(.*?)$/i))e.projectedFields.push({list:t[1],field:t[2],name:t[3]}),r[n]=m(t[3]);else if(-1!==r[n].indexOf("."))throw"[camlsql] Projected fields in the format <list>.<field_name> must be followed with an AS <alias>";if(e.fields=r,e.listName=m(l[2]),!e.listName.match(/^[a-z\d_]+$/i))throw"[camlsql] Wrap list name in brackets if it contains special characters: ["+e.listName+"]";e.query=l[3]}else e.query=""}function x(e){var t,n=[],r=e.split(",");for(t=0;t<r.length;t++)r[t]=m(r[t]),n.push(r[t]);return 1==n.length&&"*"==n[0]&&(n=[]),n}function _(e,t){var n,r,l,i,s,o,a=[],u=e.query,c=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(o=u.match(/\sORDER\sBY\s+(.*?)$/i)){if(i=o[1],u=u.substr(0,u.length-o[0].length),void 0!==i&&null!==i)for(;n=c.exec(i);){if(s=!0,l=null,n[1].indexOf(":")>0){if(!(2==(o=n[1].split(":")).length&&o[0].length>0))return[];switch(o[0]=o[0].toLowerCase(),o[0]){case"datetime":o[0]="DateTime";break;case"text":o[0]="Text";break;case"number":o[0]="Number"}l=o[0],n[1]=o[1]}r=m(n[1]),3==n.length&&(s="desc"!=(void 0!==n[2]?p(n[2].toLowerCase()):null)),a.push([r,s,l])}e.sort=a}}function C(e){var t,n,r=e.query;if(t=r.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":n="DefaultValue";break;case"recursive":n="Recursive";break;case"recursiveall":n="RecursiveAll";break;case"filesonly":n="FilesOnly"}if(!n&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==n&&(e.viewScope=n),e.query=t[1]+r.substr(t[1].length+t[2].length)}else e.viewScope=null}function k(e,t){var n,r={query:e,rowLimit:0,fields:[],sort:[],joins:[],viewScope:null,macros:[],statements:[],parameters:[],listName:null,projectedFields:[],group:null,encoded:{}};return S(r),C(r),q(r),_(r),w(r),b(r),T(r),n=G(r.query),r.statements=n.statements,r.macros=n.macros,r.query=e,r}function S(e){var t,n,r,l=e.query,i=0,s=null,o=l;for(t=0;t<l.length;t++)"["==l[t]?(i++,null===s&&(s=t)):"]"==l[t]&&0==--i&&(r=f((n=l.substring(s,t+1)).substring(1,n.length-1)),o=o.replace(n,r),s=null,e.encoded[r]=n.substring(1,n.length-1));e.query=o}function D(e,t){var n="",r=e.$options.parsedQuery,l=e.$options.parameters,i=0;return r.uuid=function(e){return i++,e+i},n+=j(r,r.statements,r.sort,l,t,{errors:[]}),n+=N(r,r.listName,r.joins),n+=I(r.projectedFields,r.joins),n+=E(r.fields),(n+=O(r.rowLimit))&&(n=V(W,{Scope:r.viewScope})+n+A("View")),{xml:n,errors:null}}function L(e){var t="";return e.group&&(t+=V("GroupBy",{Collapse:e.group.collapse?"True":null}),t+=V("FieldRef",{Name:e.group.field},!0),t+=A("GroupBy")),t}function O(e){var t="";return e>0&&(t+=V("RowLimit"),t+=e,t+=A("RowLimit")),t}function I(e,t){var n,r="",l=[];if(e.length>0&&t.length>0){for(r+=V("ProjectedFields"),n=0;n<t.length;n++)l.push(t[n].alias);for(n=0;n<e.length;n++){if(-1==l.indexOf(e[n].list))throw"[camlsql] Uknown list alias: "+e[n].list;r+=V("Field",{Name:e[n].name,List:e[n].list,Type:"Lookup",ShowField:e[n].field},!0)}r+=A("ProjectedFields")}return r}function N(e,t,n){var r,l,i="";if(n.length>0){for(i+=V("Joins"),r=0;r<n.length;r++)i+=V("Join",{ListAlias:n[r].alias}),l=n[r].childTable,i+=V("Eq"),i+=V("FieldRef",{List:n[r].childTable!=t?l:null,Name:n[r].childField,RefType:"Id"},!0),i+=V("FieldRef",{List:n[r].alias,Name:"Id"},!0),i+=A("Eq"),i+=A("Join");i+=A("Joins")}return i}function $(e){var t="";if(e.length>0){t+=V(B);for(var n=0;n<e.length;n++)t+=V(X,{Name:e[n][0],Type:e[n][2]?e[n][2]:null,Ascending:e[n][1]?null:"False"},!0);t+=A(B)}return t}function j(e,t,n,r,l,i){var s="";return(t.length>0||n.length>0||e.group&&!l)&&(s+=V(z),t.length>0&&(s+=V(H),s+=F(e,t,r,i),s+=A(H)),s+=$(n,r,i),l||(s+=L(e)),s+=A(z)),s}function F(e,t,n,r){var l="";if(!t)return"";if(t.length>1){var i="and"==t[1].operator?"And":"Or";return l+=P(e,t[0],n,r),l+=F(e,t.slice(1),n,r),"<"+i+">"+l+"</"+i+">"}return 1==t.length&&(l+=P(e,t[0],n,r)),l}function P(e,t,n,r){var l,i,s="",o=t.comparison;if("statement"==t.type){l=n[t.macro];var a={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"Lt",ne:"Neq"};if(void 0!==a[o]){if(void 0===l)throw"[camlsql] Parameter is not defined "+t.macro;if(l&&"Membership"==l.type){if("eq"!=t.comparison)throw"[camlsql] Membership comparison must be =";if("spgroup"==l.value.toLowerCase()&&!l.id)throw"[camlsql] Membership of type SPGroup requires a group id";s+=V("Membership",{Type:l.value,ID:l.id?l.id:null}),s+=V(X,{Name:t.field},!0),s+=A("Membership")}else s+=V(a[o]),s+=U(e,t,l),s+=A(a[o])}else if("null"==o)s+=V(Y),s+=U(e,t),s+=A(Y);else if("in"==o)s+=V("In"),s+=U(e,t,l),s+=A("In");else if("notnull"==o)s+=V(J),s+=U(e,t),s+=A(J);else if("like"==o){if(void 0===l)throw"[camlsql] Parameter is not defined "+t.macro;var u=R(l.value);i=u[1],l.overrideValue=u[0],s+=V(i),s+=U(e,t,l),s+=A(i)}}else s+=F(e,t.items,n,r);return s}function R(e){var t="Contains",n=e;if(!e)return[e,t];if(0===e.indexOf("%")&&"%"===e[e.length-1])n=e.replace(/^%?|%?$/g,"");else{if(0===e.indexOf("%"))throw"[camlsql] SharePoint does not support an 'EndsWith' statement: "+e;e.indexOf("%")===e.length-1&&(n=e.replace(/%?$/,""),t="BeginsWith")}return[n,t]}function U(e,t,n,r){var l="",i=null,s=t.field;if(n&&n.lookupid&&(i="True"),-1!==t.field.indexOf(".")){var o=t.field.split("."),a=!0,u=!0;if(m(o[0])==e.listName)s=o[1];else{for(c=0;c<e.projectedFields.length;c++)e.projectedFields[c].list==m(o[0])&&e.projectedFields[c].field==m(o[1])&&(s=e.projectedFields[c].name,a=!1);if(a){for(c=0;c<e.joins.length;c++)if(e.joins[c].alias==o[0]){u=!1;break}if(u)throw"[camlsql] Unknown list alias in where clause: "+o[0];if(0==e.fields.length)throw"[camlsql] The projected field '"+t.field+"' must be explicitly included in the query";s=e.uuid("camlsqlfld_"),e.projectedFields.push({list:o[0],field:o[1],name:s}),e.fields.push(s)}}}if(l+=V(X,{Name:s,LookupId:i},!0),n)if("in"==t.comparison){if(!n||n.constructor!==Array)throw"[camlsql] IN parameter must be an array";l+="<Values>";for(var c=0;c<n.length;c++)l+=M(t,n[c],n[c].value);l+="</Values>"}else l+=M(t,n);return l}function M(e,t){var n="",r="",l={},i={Type:t.type},s=t.overrideValue?t.overrideValue:t.value;return"DateTime"==t.type?(i.IncludeTimeValue=t._includeTime?"True":null,t.value&&(l.OffsetDays=s),!0===t.today?r=V("Today",l,!0):!0===t.isNow?r="<Now />":(i.StorageTZ=t._storageTZ?"True":null,r=t.stringValue?d(t.stringValue):t._storageTZ?s.toISOString():s.getFullYear()+"-"+c(s.getMonth()+1)+"-"+c(s.getDate())+"T"+c(s.getHours())+":"+c(s.getMinutes())+":"+c(s.getSeconds()))):"Text"==t.type?r=1==t.multiline?"<![CDATA["+d(s)+"]]>":d(s):"Number"==t.type?r=s:"User"==t.type?"number"==typeof s?(i.Type="User",r=d(s+"")):(i.Type="Number",r="<UserID />"):"Lookup"==t.type?(1==t.byId&&(i.LookupId="True"),r=d(s+"")):r="Boolean"==t.type?s?1:0:V("NotImplemented",{},!0),n+=V("Value",i),n+=r,n+=A("Value")}function E(e){var t,n="";if(e.length>0){for(n+=V(Q),t=0;t<e.length;t++){if(!e[t].match(/^[a-zA-Z_\d]+$/i))throw"[camlsql] Invalid syntax: "+e[t];n+=V(X,{Name:e[t]},!0)}n+=A(Q)}return n}function V(e,t,n){var r,l="<"+e,i=t?Object.keys(t):[];for(r=0;r<i.length;r++)void 0!==t[i[r]]&&null!==t[i[r]]&&(l+=" "+i[r]+'="'+d(t[i[r]])+'"');return l+(n?" /":"")+">"}function A(e){return"</"+e+">"}var Z={type:"DateTime",today:!1,_includeTime:!1,value:null,_storageTZ:!1,stringValue:"",add:function(t){this.errstr();var n=e(t);return this.value=new Date(this.value.getTime()+n),this.today=!1,this},sub:function(t){this.errstr();var n=e(t);return this.value=new Date(this.value.getTime()-n),this.today=!1,this},startOfWeek:function(e){return this.errstr(),this.value=t("week start"+(e?"":" monday"),this.value),this.today=!1,this},endOfWeek:function(e){return this.errstr(),this.value=t("week end"+(e?"":" monday"),this.value),this.today=!1,this},startOfMonth:function(){return this.errstr(),this.value=t("month start",this.value),this.today=!1,this},endOfMonth:function(){return this.errstr(),this.value=t("month end",this.value),this.today=!1,this},endOfDay:function(){return this.errstr(),this.value=t("day end",this.value),this.today=!1,this},startOfDay:function(){return this.errstr(),this.value=t("day start",this.value),this.today=!1,this},storageTZ:function(e){return this._storageTZ=!!e,this.today=!1,this},includeTime:function(e){return this._includeTime=!!e,this},errstr:function(){if(this.stringValue)throw"[camlsql] You can't do that when DateTime was set as a string"}},G=function(e,t){function n(e){return e.replace(/^\s+|\s+$/g,"")}function r(e,o){var a,u,c,f,d,p,g,y,v,w=null,b=null,q=[],T=0,x=null;for(e=h(e),o=o||0,a=0;a<e.length;a++)e[a]==i?(0==T&&(a>0&&0==q.length?q.push(e.substring(0,a)):null!=x&&q.push(e.substring(x,a)),w=a,b=null),T++):e[a]==s&&null!==w&&0==--T&&(w,q.push(n(e.substring(w,a+1)).replace(/^\(|\)$/g,"")),b=a+1,x=a+1,w=null);for(null!=b&&null==w?n(e.substring(b))&&q.push(n(e.substring(b))):null!=w||0==q.length&&null==w&&null==b&&q.push(n(e)),a=0;a<q.length;a++)if(u="and",q[a].match(/^\s*(\|\||(or))\s*/i)&&(u="or"),q[a].match(/\s*(?:\|\||(or))\s*$/gi)&&a<q.length-1&&(q[a+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(q[a+1]="or "+q[a+1])),q[a]=q[a].replace(/\s*(\&\&|and)\s*$/i,""),q[a]=q[a].replace(/\s*(\|\||or)\s*$/i,""),q[a]=q[a].replace(/^\s*(\&\&|and)\s*/i,""),q[a]=q[a].replace(/^\s*(\|\||or)\s*/i,""),q[a]={type:"statement",value:q[a],operator:u},q[a].value.indexOf(i)>0)(f=r(q[a].value,o+1)).length>1&&(q[a].type="group",q[a].items=f);else{for(c=q[a].value.split(/ (\|\||or|and|\&\&) /i),q[a].type="statement",d=[],p=0;p<c.length;p++)if(g={type:"statement",operator:"and"},""!=n(c[p])&&"and"!=c[p].toLowerCase()&&"or"!=c[p].toLowerCase()&&"||"!=c[p]&&"&&"!=c[p])if(p>0&&("or"!=c[p-1].toLowerCase()&&"||"!=c[p-1]||(g.operator="or")),y=l(c[p]))g.field=m(y.field),g.macro=y.macro,g.comparison=y.comparison,d.push(g);else if(!t)throw"[camlsql] Could not parse statement: "+c[p];d.length>1?(q[a].type="group",q[a].items=d):1==d.length&&(q[a].field=m(d[0].field),q[a].macro=d[0].macro,q[a].comparison=d[0].comparison)}for(v=[],a=0;a<q.length;a++)q[a].value&&v.push(q[a]);return v}function l(e){if(void 0===e)return null;var t=(e=(e=e.replace(/ is\s+not\s+null/i," cxqlisnotnull ?")).replace(/ is\s+null/i," cxqlisnull ?")).match(/([a-zA-Z_\d\.]+)\s*(<>|>=|[^<]>|<=|<[^>]|=|\slike|\scxqlisnull|\scxqlisnotnull|in)\s*(\?|@[a-z0-9_]+)/i);if(t){var r="eq",l="@param"+u,i=n(t[2]);if(">"==i&&(r="gt"),">="==i&&(r="gte"),"<"==i&&(r="lt"),"<="==i&&(r="lte"),"=="==i&&(r="eq"),"<>"!=i&&"!="!=i||(r="ne"),"like"==i.toLowerCase()&&(r="like"),"cxqlisnull"==i.toLowerCase()&&(r="null"),"cxqlisnotnull"==i.toLowerCase()&&(r="notnull"),"in"==i.toLowerCase()&&(r="in"),"cxqlisnull"!=r&&"cxqlisnotnull"!=r){if(u++,c++,null==o)o=t[3][0];else if(o!=t[3][0])throw"[camlsql] You can not mix named macros and ?";"@"==t[3][0]&&(l=t[3]),f.push(l)}else l=null;return{field:m(t[1]),comparison:r,macro:l}}return null}var i="(",s=")",o=null,a={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return a;var u=0,c=0,f=[],d=r(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==d&&(a.statements=d),a.macroType=o,a.macroCount=c,a.macros=f,a},W="View",Q="ViewFields",X="FieldRef",z="Query",B="OrderBy",H="Where",Y="IsNull",J="IsNotNull";return{prepare:function(e,t){return new g(e,t)},text:l,guid:function(e){return{type:"Guid",value:e}},number:s,lookup:function(e){if("string"!=typeof e&&"number"!=typeof e)throw"[camlsql] Value must be number or string";return{type:"Lookup",value:e,lookupid:"number"==typeof e,byId:"number"==typeof e}},date:function(e){var t=o(e);return t&&(t._includeTime=!1),t},datetime:o,today:function(e,t){if(void 0===e&&(e=0),"number"!=typeof e)throw"[camlsql] Bad offset value for 'today'";return{type:"DateTime",today:!0,value:e,_includeTime:!0===t}},multichoice:function(e){return{type:"MultiChoice",value:e}},choice:function(e){return{type:"Choice",value:e}},user:function(e){return"number"==typeof e?{type:"User",value:e,lookupid:!0}:{type:"User"}},boolean:i,encode:f,membership:function(e,t){var n,r=["SPWeb.AllUsers","SPGroup","SPWeb.Groups","CurrentUserGroups","SPWeb.Users"],l=null;if(!e)throw"Membership type should be one of "+r.join(", ");for(n=0;n<r.length;n++)if(r[n].toLowerCase()==e.toLowerCase()&&(e=r[n],l=n,"SPGroup"===e&&"number"!=typeof t))throw"[camlsql] When using SPGroup you must specify a numeric GroupID";if(null===l)throw"Membership type should be one of "+r.join(", ");return{type:"Membership",value:e,id:t}}}});