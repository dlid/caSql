/*! camlsqj-js v1.0.1 | (c) dlid.se | https://camlsqljs.dlid.se/license */
!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():e.camlsql=t()}(this,function(){"use strict";function e(e){var t,n=0;if("string"!=typeof e)throw"[camlsql] Interval value must be a string";if(e=e.toLowerCase(),t=e.match(/^(\d+) (day|hour|minute|second|ms|millisecond)s?$/i)){switch(e=parseInt(e,10),t[2]){case"day":n=24*e*60*60;break;case"hour":n=60*e*60;break;case"minute":n=60*e;break;case"second":n=e;break;case"ms":case"millisecond":n=e/1e3}return 1e3*n}throw"[camlsql] Interval string was not recognized: "+e}function t(e,t){var a;return e=u(e.toLowerCase()),t=t?new Date(+t):new Date,"month start"==e?a=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0):"month end"==e?a=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999):"week start"==e?a=n(t):"week start monday"==e?a=n(t,!0):"week end monday"==e?a=r(t,!0):"week end"==e?a=r(t):"day start"==e?a=new Date(t.setHours(0,0,0,0)):"day end"==e&&(a=new Date(t.setHours(23,59,59,999))),a}function n(e,t){(e=e?new Date(+e):new Date).setHours(0,0,0,0),t=!!t;var n=e.getDay();return!0===t&&(0==n?n=6:n-=1),e.setDate(e.getDate()-n),e}function r(e,t){return e=n(e,t),e.getDay(),e.setDate(e.getDate()+6),new Date(e.setHours(23,59,59,999))}function a(e){if("string"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a string";var t;return t={type:"Text",value:e=void 0!==e?e:""},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t}function l(e){if("number"!=typeof e&&void 0!==e)throw"[camlsql] Value was not a number";return e=e||0,{type:"Number",value:e}}function s(e){var t,n=!1;return void 0!==e&&N.isPrototypeOf(e)&&(e=e.value),"string"==typeof e?(t=e+"",e=null):(e||(n=!0),e=e?new Date(+e):new Date),Object.create(N,{type:{value:"DateTime"},value:{value:e,writable:!0},_includeTime:{value:!0,writable:!0},today:{value:n,writable:!0},_storageTZ:{value:!0,writable:!0},stringValue:{value:t,writable:!1}})}function i(e){function t(){var t=new SP.CamlQuery,a=e.query.getXml();t.set_viewXml(a),c=o.getItems(t),r.load(c),r.executeQueryAsync(n,function(t,n){var r="";n&&-2130575340==n.get_errorCode()&&(r+=" (Error -2130575340: Check field names)"),i({status:"error",message:"Error executing the SP.CamlQuery"+r,data:{sql:e.query.$options.parsedQuery.query,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)})}function n(){var e,t=c.getEnumerator(),n=[],r=c.get_listItemCollectionPosition();for(r&&(a=r.get_pagingInfo());t.moveNext();)e=t.get_current(),l||(l="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id())),n.push(e.get_fieldValues());i(null,n,{nextPage:a,prevPage:l})}var r,a,l,s=e.spWeb,i=e.callback,o=null,u=e.query.getListName(),c=null,f=e.query.getXml();if(console.log("[exec]",e),"function"!=typeof i&&(i=null),"undefined"!=typeof SP)SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){}),SP.SOD.executeOrDelayUntilScriptLoaded(function(){console.log("[camlsql] all is well"),r=SP.ClientContext.get_current(),s||(console.log("[camlsql] spweb is not"),s=r.get_web(),o=s.get_lists().getByTitle(u),r.load(o),r.executeQueryAsync(t,function(){if(null==i)throw"[camlsql] Failed to load list";i({status:"error",message:"Failed to load list",data:{sql:e.query.$options.parsedQuery.query,viewXml:f,listName:u,error:Array.prototype.slice.call(arguments)}},null)}))},"sp.js");else{if(null==i)throw"[camlsql] SP is not defined";i({status:"error",message:"SP is not defined",data:null},null)}}function o(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function u(e){return e.replace(/^\s+|\s+$/g,"")}function c(e){return u(e).replace(/^\[|\]$/g,"")}function f(e,t){var n=this,r=m(t);console.log("parameters",r),this.exec=function(){var e,t,n=Array.prototype.slice.call(arguments);return n.length>1?"object"==typeof n[0]&&(e=n[0],"function"==typeof n[1]&&(t=n[1])):1==n.length&&("object"==typeof n[0]?e=n[0]:"function"==typeof n[0]&&(t=n[0])),i({query:this,callback:t,spWeb:e}),this},this.getListName=function(){return n.$options.parsedQuery.listName},this.getXml=function(){return new q(n).xml},this.$options={parsedQuery:w(e),parameters:r}}function m(e){var t,n,r={};if(e&&e.length>0)for(t=0;t<e.length;t++)(n=d(e[t]))&&(r["@param"+t]=n);return r}function d(e){var t,n=null;if(null==e)return null;if(null!==e&&e.constructor===Array)for(n=[],t=0;t<e.length;t++)n.push(d(e[t]));else if("string"==typeof e)n=a(e);else if("number"==typeof e)n=l(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return n}function h(e){var t;(t=e.query.match(/\sLIMIT\s(\d+).*$/i))&&(e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10))}function p(e){var t,n=[],r=e.query.match(/^SELECT\s(.*?)\sFROM\s(.*?)(?:\s+(where.*)$|$)/i);if(r)if(4==r.length){for(n=g(r[1]),t=0;t<n.length;t++)n[t].match(/^[a-z:A-Z_\\d]+$/)||console.warn&&console.warn("[camlsql] Doubtful field name: "+n[t]);e.fields=n,e.listName=c(r[2]),e.query=r[3]}else e.query=""}function g(e){var t,n=[],r=e.split(",");for(t=0;t<r.length;t++)r[t]=c(r[t]),n.push(r[t]);return 1==n.length&&"*"==n[0]&&(n=[]),n}function y(e,t){var n,r,a,l,s,i,o=[],f=e.query,m=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(i=f.match(/\sORDER\sBY\s(.*?)$/i)){if(l=i[1],f=f.substr(0,f.length-i[0].length),void 0!==l&&null!==l)for(;n=m.exec(l);){if(s=!0,a=null,n[1].indexOf(":")>0){if(!(2==(i=n[1].split(":")).length&&i[0].length>0))return[];switch(i[0]=i[0].toLowerCase(),i[0]){case"datetime":i[0]="DateTime";break;case"text":i[0]="Text";break;case"number":i[0]="Number";break;case"datetime":i[0]="DateTime"}a=i[0],n[1]=i[1]}r=c(n[1]),3==n.length&&(s="desc"!=(void 0!==n[2]?u(n[2].toLowerCase()):null)),o.push([r,s,a])}e.sort=o}}function v(e){var t,n,r=e.query;if(t=r.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":n="DefaultValue";break;case"recursive":n="Recursive";break;case"recursiveall":n="RecursiveAll";break;case"filesonly":n="FilesOnly"}if(!n&&console.error)throw"[camlsql] Unknown scope '"+t[3]+"'";void 0!==n&&(e.viewScope=n),e.query=t[1]+r.substr(t[1].length+t[2].length)}else e.viewScope=null}function w(e,t){var n,r={query:e,rowLimit:0,fields:[],sort:[],viewScope:null,macros:[],statements:[],parameters:[],listName:null};return v(r),h(r),y(r),p(r),n=S(r.query),r.statements=n.statements,r.macros=n.macros,r.query=e,r}function q(e){var t="",n=e.$options.parsedQuery,r=e.$options.parameters;return t+=L(n.fields),(t+=T(n.statements,n.sort,r,{errors:[]}))&&(t=$(E,{Scope:n.viewScope})+t+_("View")),console.log("query",e),{xml:t,errors:null}}function b(e){var t="";if(e.length>0){t+=$(V);for(var n=0;n<e.length;n++)t+=$(P,{Name:e[n][0],Type:e[n][2]?e[n][2]:null,Ascending:e[n][1]?null:"False"},!0);t+=_(V)}return t}function T(e,t,n,r){console.warn("CREATE QUERY ELEMENT",e,n);var a="";return(e.length>0||t.length>0)&&(a+=$(R),e.length>0&&(a+=$(A),a+=D(e,n,r),a+=_(A)),a+=b(t,n,r),a+=_(R)),a}function D(e,t,n){var r="";if(!e)return"";if(e.length>1){var a="and"==e[1].operator?"And":"Or";return r+=x(e[0],t,n),r+=D(e.slice(1),t,n),"<"+a+">"+r+"</"+a+">"}return 1==e.length&&(r+=x(e[0],t,n)),r}function x(e,t,n){var r,a,l="",s=e.comparison;if("statement"==e.type){r=t[e.macro];var i={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"Lt",ne:"Neq"};if(void 0!==i[s]){if(void 0===r)throw"[camlsql] Parameter is not defined "+e.macro;l+=$(i[s]),l+=k(e,r),l+=_(i[s])}else if("null"==s)l+=$(Q),l+=k(e),l+=_(Q);else if("notnull"==s)l+=$(F),l+=k(e),l+=_(F);else if("like"==s){if(void 0===r)throw"[camlsql] Parameter is not defined "+e.macro;l+=$(a=C(r.value)),l+=k(e,r),l+=_(a)}}else l+=D(e.items,t,n);return l}function C(e){var t="Contains";if(0===e.indexOf("%")&&"%"===e[e.length-1])e.replace(/^%?|%?$/g,"");else{if(0===e.indexOf("%"))throw"[casql] SharePoint does not support an 'EndsWith' statement: "+e;e.indexOf("%")===e.length-1&&(e.replace(/%?$/,""),t="BeginsWith")}return t}function k(e,t,n){var r="";return r+=$(P,{Name:e.field},!0),t&&("in"==e.comparison?r="<In>x</In>":r+=O(e,t)),r}function O(e,t){console.warn("creatValueElement",e,t);var n="",r="",a={Type:t.type};return"DateTime"==t.type?(a.IncludeTimeValue=t._includeTime?"True":null,!0===t.today?r="<Today />":!0===t.isNow?r="<Now />":(a.StorageTZ=t._storageTZ?"True":null,r=t.stringValue?o(t.stringValue):t.value.toISOString())):r="Text"==t.type?1==t.multiline?"<![CDATA["+o(t.value)+"]]>":o(t.value):"Number"==t.type?t.value:$("NotImplemented",{},!0),n+=$("Value",a),n+=r,n+=_("Value")}function L(e){var t,n="";if(e.length>0){for(n+=$(I),t=0;t<e.length;t++)n+=$(P,{Name:e[t]},!0);n+=_(I)}return n}function $(e,t,n){var r,a="<"+e,l=t?Object.keys(t):[];for(r=0;r<l.length;r++)void 0!==t[l[r]]&&null!==t[l[r]]&&(a+=" "+l[r]+'="'+o(t[l[r]])+'"');return a+(n?" /":"")+">"}function _(e){return"</"+e+">"}var N={type:"DateTime",today:!1,_includeTime:!1,value:null,_storageTZ:!0,stringValue:"",add:function(t){this.errstr();var n=e(t);return this.value=new Date(this.value.getTime()+n),this},sub:function(t){this.errstr();var n=e(t);return this.value=new Date(this.value.getTime()-n),this},startOfWeek:function(e){return this.errstr(),this.value=t("week start"+(e?"":" monday"),this.value),this.today=!1,this},endOfWeek:function(e){return this.errstr(),this.value=t("week end"+(e?"":" monday"),this.value),this.today=!1,this},startOfMonth:function(){return this.errstr(),this.value=t("month start",this.value),this.today=!1,this},endOfMonth:function(){return this.errstr(),this.value=t("month end",this.value),this.today=!1,this},endOfDay:function(){return this.errstr(),this.value=t("day end",this.value),this.today=!1,this},startOfDay:function(){return this.errstr(),this.value=t("day start",this.value),this.today=!1,this},storageTZ:function(e){return this._storageTZ=!!e,this.today=!1,this},includeTime:function(e){return this._includeTime=!!e,this},errstr:function(){if(this.stringValue)throw"[camlsql] You can't do that when DateTime was set as a string"}},S=function(e,t){function n(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){var i,o,u,c,f,m,d,h,p,g=null,y=null,v=[],w=0;for(i=0;i<e.length;i++)e[i]==l?(0==w&&(i>0&&v.push(e.substring(0,i)),g=i,y=null),w++):e[i]==s&&null!==g&&0==--w&&(v.push(n(e.substring(g,i+1)).replace(/^\(|\)$/g,"")),y=i+1);for(null!=y?v.push(n(e.substring(y))):0==v.length&&null==g&&null==y&&v.push(n(e)),i=0;i<v.length;i++)if(o="and",v[i].match(/^\s*(\|\||(or))\s*/i)&&(o="or"),v[i].match(/\s*(?:\|\||(or))\s*$/gi)&&i<v.length-1&&(v[i+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(v[i+1]="or "+v[i+1])),v[i]=v[i].replace(/\s*(\&\&|and)\s*$/i,""),v[i]=v[i].replace(/\s*(\|\||or)\s*$/i,""),v[i]=v[i].replace(/^\s*(\&\&|and)\s*/i,""),v[i]=v[i].replace(/^\s*(\|\||or)\s*/i,""),v[i]={type:"statement",value:v[i],operator:o},-1!==v[i].value.indexOf(l))(c=r(v[i].value)).length>1&&(v[i].type="group",v[i].items=c);else{for(u=v[i].value.split(/ (\|\||or|and|\&\&) /i),v[i].type="statement",f=[],m=0;m<u.length;m++)if(d={type:"statement",operator:"and"},""!=n(u[m])&&"and"!=u[m].toLowerCase()&&"or"!=u[m].toLowerCase()&&"||"!=u[m]&&"&&"!=u[m])if(m>0&&("or"!=u[m-1].toLowerCase()&&"||"!=u[m-1]||(d.operator="or")),h=a(u[m]))d.field=h.field,d.macro=h.macro,d.comparison=h.comparison,f.push(d);else if(!t)throw"[casql] Could not parse statement: "+u[m];f.length>1?(v[i].type="group",v[i].items=f):1==f.length&&(v[i].field=f[0].field,v[i].macro=f[0].macro,v[i].comparison=f[0].comparison)}for(p=[],i=0;i<v.length;i++)v[i].value&&p.push(v[i]);return p}function a(e){if(void 0===e)return null;var r=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(r){var a="eq",l="@param"+u,s=n(r[2]);if(">"==s&&(a="gt"),">="==s&&(a="gte"),"<"==s&&(a="lt"),"<="==s&&(a="lte"),"=="==s&&(a="eq"),"<>"!=s&&"!="!=s||(a="ne"),"like"==s.toLowerCase()&&(a="like"),"isnull"==s.toLowerCase()&&(a="null"),"isnotnull"==s.toLowerCase()&&(a="notnull"),"in"==s.toLowerCase()&&(a="in"),"null"!=a&&"notnull"!=a){if(u++,f++,null==i)i=r[3];else if(i!=r[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==r[3][0]&&(l=r[3]),m.push(l)}else l=null;return{field:c(r[1]),comparison:a,macro:l}}return null}var l="(",s=")",i=null,o={statements:[],macroType:null,macroCount:0,macros:[]};if(void 0===e)return o;var u=0,f=0,m=[],d=r(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1"));return void 0!==d&&(o.statements=d),o.macroType=i,o.macroCount=f,o.macros=m,o},E="View",I="ViewFields",P="FieldRef",R="Query",V="OrderBy",A="Where",Q="IsNull",F="IsNotNull";return{prepare:function(e,t){return new f(e,t)},text:a,guid:function(e){return{type:"Guid",value:e}},number:l,lookup:function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},date:function(e){var t=s(e);return t&&(t._includeTime=!1),t},datetime:s,today:function(e,t){if(void 0===e&&(e=0),"number"!=typeof e)throw"[camlsql] Bad offset value for 'today'";return{type:"DateTime",today:!0,value:e,_includeTime:!0===t}},multichoice:function(e){return{type:"MultiChoice",value:e}},choice:function(e){return{type:"Choice",value:e}},url:function(e){return{type:"URL",value:e}},user:function(e){return{type:"User",value:e}}}});