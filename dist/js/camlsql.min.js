var camlsql=function(e,l){function t(e){return r(e).replace(/^\[|\]$/g,"")}function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var l=null;if(null!==e&&e.constructor===Array){l=[];for(var t=0;t<e.length;t++)l.push(n(e[t]))}else if("string"==typeof e)l=camlsql.text(e);else if("number"==typeof e)l=camlsql.number(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return l}function o(e){var l="";if(!e)return"";if(e.length>1){var t="and"==e[1].operator?"And":"Or";return l+=a(e[0]),l+=o(e.slice(1)),"<"+t+">"+l+"</"+t+">"}return 1==e.length&&(l+=a(e[0])),l}function a(e){var l="";if("statement"==e.type){var t=d[e.macro];if("null"!==e.comparison&&"notnull"!==e.comparison&&void 0===t)return l+="<casql:Error>"+("Parameter not found ("+e.macro+")").encodeHTML()+"</casql:Error>",f||console.error("[casql] Parameter not found",e.macro),l;var r={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"lt",ne:"Neq"};if(void 0!==r[e.comparison])l+="<"+(n=r[e.comparison])+">",l+=i(e,t),l+="</"+n+">";else if("in"==e.comparison)l+="<IsNull>",l+=i(e,t),l+="</IsNull>";else if("null"==e.comparison)l+="<IsNull>",l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="</IsNull>";else if("notnull"==e.comparison)l+="<IsNotNull>",l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="</IsNotNull>";else if("like"==e.comparison){var n="Contains",a=null;0===t.value.indexOf("%")&&"%"===t.value[t.value.length-1]?a=t.value.replace(/^%?|%?$/g,""):0===t.value.indexOf("%")?(console.warn("[casql] SharePoint does not support an 'EndsWith' statement. Contains will be used instead. (Field '"+e.field+"')"),a=t.value.replace(/^%?/,"")):t.value.indexOf("%")===t.value.length-1&&(a=t.value.replace(/%?$/,""),n="BeginsWith"),l+="<"+n+">",l+=i(e,t,a),l+="</"+n+">"}else l+="<NOT_IMPLEMENTED>"+e.comparison+"</NOT_IMPLEMENTED>"}else l+=o(e.items);return l}function u(e,l,t){var r="";return"DateTime"==l.type?!0===l.today&&(r="<Today",t&&(r+=' OffsetDays="'+t+'"'),r+=" />"):"Text"==l.type?!0===l.multiline?(r="<<![CDATA[",r+=t,r+="]]>"):r+=t.encodeHTML():"Number"==l.type&&(r+=t),r='<Value Type="'+l.type+'">'+r+"</Value>"}function i(e,l,t){var r="",n="",o=void 0!==t&&null!==t?t:l?l.value:null;if("in"==e.comparison){r+='<FieldRef Name="'+e.field.encodeHTML()+'" />',r+="<Values>";for(var a=0;a<l.length;a++)r+=u(e,l[a],l[a].value);return r+="</Values>"}return n=u(e,l,o),r+='<FieldRef Name="'+e.field.encodeHTML()+'" />',r+='<Value Type="'+l.type+'">'+n+"</Value>"}function s(){return e}var c=function(e,l){function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var t=null,i=null,s=[],c=0;for(_=0;_<e.length;_++)e[_]==a?(0==c&&(_>0&&s.push(e.substring(0,_)),t=_,i=null),c++):e[_]==u&&null!==t&&0==--c&&(s.push(r(e.substring(t,_+1)).replace(/^\(|\)$/g,"")),i=_+1);null!=i?s.push(r(e.substring(i))):0==s.length&&null==t&&null==i&&s.push(r(e));for(_=0;_<s.length;_++){var p="and";if(s[_].match(/^\s*(\|\||(or))\s*/i)&&(p="or"),s[_].match(/\s*[\|\||(or)]\s*$/gi)&&_<s.length-1&&(s[_+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(s[_+1]="or "+s[_+1])),s[_]=s[_].replace(/\s*(\&\&|and)\s*$/i,""),s[_]=s[_].replace(/\s*(\|\||or)\s*$/i,""),s[_]=s[_].replace(/^\s*(\&\&|and)\s*/i,""),s[_]=s[_].replace(/^\s*(\|\||or)\s*/i,""),s[_]={type:"statement",value:s[_],operator:p},-1!==s[_].value.indexOf(a)){var m=n(s[_].value);m.length>1&&(s[_].type="group",s[_].items=m)}else{var f=s[_].value.split(/ (\|\||or|and|\&\&) /i);s[_].type="statement";for(var d=[],v=0;v<f.length;v++){var y={type:"statement",operator:"and"};if(""!=r(f[v])&&("and"!=f[v].toLowerCase()&&"or"!=f[v].toLowerCase()&&"||"!=f[v]&&"&&"!=f[v])){v>0&&("or"!=f[v-1].toLowerCase()&&"||"!=f[v-1]||(y.operator="or"));var g=o(f[v]);g?(y.field=g.field,y.macro=g.macro,y.comparison=g.comparison,d.push(y)):l||console.error("[casql] Could not parse statement","'"+f[v]+"'")}}d.length>1?(s[_].type="group",s[_].items=d):1==d.length&&(s[_].field=d[0].field,s[_].macro=d[0].macro,s[_].comparison=d[0].comparison)}}for(var h=[],_=0;_<s.length;_++)s[_].value&&h.push(s[_]);return h}function o(e){if(void 0===e)return null;var n=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(n){var o="eq",a="@param"+s,u=r(n[2]);if(">"==u&&(o="gt"),">="==u&&(o="gte"),"<"==u&&(o="lt"),"<="==u&&(o="lte"),"=="==u&&(o="eq"),"<>"!=u&&"!="!=u||(o="ne"),"like"==u.toLowerCase()&&(o="like"),"isnull"==u.toLowerCase()&&(o="null"),"isnotnull"==u.toLowerCase()&&(o="notnull"),"in"==u.toLowerCase()&&(o="in"),"null"!=o&&"notnull"!=o){if(s++,c++,null==i)i=n[3];else if(i!=n[3])return l||console.error("[casql] You can not mix named macros and ?"),null;"@"==n[3][0]&&(a=n[3]),p.push(a)}else a=null;return{field:t(n[1]),comparison:o,macro:a}}return null}var a="(",u=")",i=null;if(void 0===e)return[];var s=0,c=0,p=[];return{statements:n(e=(e=e.replace(/^.*?(WHERE )/i,"")).replace(/(.*?)\s?ORDER BY.*$/i,"$1")),macroType:i,macroCount:c,macros:p}},p=function(){function e(){var e=new SP.CamlQuery,r=c;e.set_viewXml(r),i=a.getItems(e),t.load(i),t.executeQueryAsync(l,function(){o({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:s,viewXml:c,listName:u,error:Array.prototype.slice.call(arguments)}},null)})}function l(){for(var e,l=i.getEnumerator(),t=[];l.moveNext();)e=l.get_current(),t.push(e.get_fieldValues());o(null,t)}var t,r=Array.prototype.slice.call(arguments),n=null,o=null,a=null,u=this.getListName(),i=null,c=this.getXml();return r.length>1?"object"==typeof r[0]&&(n=r[0],"function"==typeof r[1]&&(o=r[1])):1==r.length&&("object"==typeof r[0]?n=r[0]:"function"==typeof r[0]&&(o=r[0])),"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){t=SP.ClientContext.get_current(),null===n&&(n=t.get_web(),a=n.get_lists().getByTitle(u),t.load(a),t.executeQueryAsync(e,function(){o({status:"error",message:"Failed to load list",data:{sql:s,viewXml:c,listName:u,error:Array.prototype.slice.call(arguments)}},null)}))}):o({status:"error",message:"SP is not defined",data:null},null),console.log({web:n,callback:o}),this},m={query:e},f=!1;3==arguments.length&&1==arguments[2]&&(f=!0),String.prototype.encodeHTML||(String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")});var d={};if(l&&l.length>0){m.originalParam=l;for(g=0;g<l.length;g++)d["@param"+g]=n(l[g]);m.param=d}var v=function(e){var l,r,n,o=e.match(/^SELECT (.*?) FROM (.*?)(?:\s(.*)$|$)/i),a=[];if(o&&4==o.length){for(r=o[1].split(","),n=0;n<r.length;n++)r[n]=r[n].replace(/^[\s\[]*|[\s\]]*$/g,""),a.push(r[n]);l=t(o[2])}1==a.length&&"*"==a[0]&&(a=[]);var u=c(o[3],f);return{listName:l,viewFields:a,where:u.statements,macroType:u.macroType,macroCount:u.macroCount,macros:u.macros}}(e),y="<View>";if(v.viewFields.length>0){y+="<ViewFields>";for(var g=0;g<v.viewFields.length;g++)y+='<FieldRef Name="'+v.viewFields[g].encodeHTML()+'" />';y+="</ViewFields>"}m.macroType=v.macroType,m.macroCount=v.macroCount,m.macros=v.macros;var h=o(v.where);h&&(y+="<Query><Where>"+h+"</Where></Query>"),y+="</View>";var _={getXml:function(){return y},getListName:function(){return v.listName},_properties:m};return void 0!==p&&(_.exec=p),_};camlsql.__proto__.text=function(e){var l;return l={type:"Text",value:e},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(l.multiline=!0),l},camlsql.__proto__.number=function(e){return"number"!=typeof e?(console.error("[camlsql] value was not a number",e),null):{type:"Number",value:e}},camlsql.__proto__.lookup=function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},camlsql.__proto__.datetime=function(e){return"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e}:(console.error("[camlsql] Bad format for datetime value"),null)},camlsql.__proto__.today=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},camlsql.__proto__.month=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",month:!0,value:e}},camlsql.__proto__.guid=function(e){return{type:"Guid",value:e}},camlsql.__proto__.multichoice=function(e){return{type:"MultiChoice",value:e}},camlsql.__proto__.url=function(e){return{type:"URL",value:e}},camlsql.__proto__.prepare=function(){var e=Array.prototype.slice.call(arguments);return e.unshift(null),new(Function.prototype.bind.apply(camlsql,e))};