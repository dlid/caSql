var camlsql=function(e,r){function t(e){return l(e).replace(/^\[|\]$/g,"")}function l(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var r=null;if(null==e)return null;if(null!==e&&e.constructor===Array){r=[];for(var t=0;t<e.length;t++)r.push(n(e[t]))}else if("string"==typeof e)r=camlsql.text(e);else if("number"==typeof e)r=camlsql.number(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return r}function o(e){var r="";if(!e)return"";if(e.length>1){var t="and"==e[1].operator?"And":"Or";return r+=a(e[0]),r+=o(e.slice(1)),"<"+t+">"+r+"</"+t+">"}return 1==e.length&&(r+=a(e[0])),r}function a(e){var r="";if("statement"==e.type){var t=v[e.macro];if(console.warn("",e.macro,e),"null"!==e.comparison&&"notnull"!==e.comparison&&void 0===t)return r+="<casql:Error>"+("Parameter not found ("+e.macro+")").encodeHTML()+"</casql:Error>",d||console.error("[casql] Parameter not found",e.macro),r;var l={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"lt",ne:"Neq"};if(void 0!==l[e.comparison])r+="<"+(n=l[e.comparison])+">",r+=u(e,t),r+="</"+n+">";else if("in"==e.comparison)r+="<IsNull>",r+=u(e,t),r+="</IsNull>";else if("null"==e.comparison)r+="<IsNull>",r+='<FieldRef Name="'+e.field.encodeHTML()+'" />',r+="</IsNull>";else if("notnull"==e.comparison)r+="<IsNotNull>",r+='<FieldRef Name="'+e.field.encodeHTML()+'" />',r+="</IsNotNull>";else if("like"==e.comparison){var n="Contains",a=null;0===t.value.indexOf("%")&&"%"===t.value[t.value.length-1]?a=t.value.replace(/^%?|%?$/g,""):0===t.value.indexOf("%")?(console.warn("[casql] SharePoint does not support an 'EndsWith' statement. Contains will be used instead. (Field '"+e.field+"')"),a=t.value.replace(/^%?/,"")):t.value.indexOf("%")===t.value.length-1&&(a=t.value.replace(/%?$/,""),n="BeginsWith"),r+="<"+n+">",r+=u(e,t,a),r+="</"+n+">"}else r+="<NOT_IMPLEMENTED>"+e.comparison+"</NOT_IMPLEMENTED>"}else r+=o(e.items);return r}function i(e,r,t){var l="";return"DateTime"==r.type?!0===r.today&&(l="<Today",t&&(l+=' OffsetDays="'+t+'"'),l+=" />"):"Text"==r.type?!0===r.multiline?(l="<<![CDATA[",l+=t,l+="]]>"):l+=t.encodeHTML():"Number"==r.type&&(l+=t),l='<Value Type="'+r.type+'">'+l+"</Value>"}function u(e,r,t){var l="",n="",o=void 0!==t&&null!==t?t:r?r.value:null;if("in"==e.comparison){l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="<Values>";for(var a=0;a<r.length;a++)l+=i(e,r[a],r[a].value);return l+="</Values>"}return n=i(e,r,o),l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+=n}function s(){return e}var c=function(e,r){function l(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var t=null,u=null,s=[],c=0;for(_=0;_<e.length;_++)e[_]==a?(0==c&&(_>0&&s.push(e.substring(0,_)),t=_,u=null),c++):e[_]==i&&null!==t&&0==--c&&(s.push(l(e.substring(t,_+1)).replace(/^\(|\)$/g,"")),u=_+1);null!=u?s.push(l(e.substring(u))):0==s.length&&null==t&&null==u&&s.push(l(e));for(_=0;_<s.length;_++){var m="and";if(s[_].match(/^\s*(\|\||(or))\s*/i)&&(m="or"),s[_].match(/\s*[\|\||(or)]\s*$/gi)&&_<s.length-1&&(s[_+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(s[_+1]="or "+s[_+1])),s[_]=s[_].replace(/\s*(\&\&|and)\s*$/i,""),s[_]=s[_].replace(/\s*(\|\||or)\s*$/i,""),s[_]=s[_].replace(/^\s*(\&\&|and)\s*/i,""),s[_]=s[_].replace(/^\s*(\|\||or)\s*/i,""),s[_]={type:"statement",value:s[_],operator:m},-1!==s[_].value.indexOf(a)){var p=n(s[_].value);p.length>1&&(s[_].type="group",s[_].items=p)}else{var f=s[_].value.split(/ (\|\||or|and|\&\&) /i);s[_].type="statement";for(var d=[],v=0;v<f.length;v++){var g={type:"statement",operator:"and"};if(""!=l(f[v])&&("and"!=f[v].toLowerCase()&&"or"!=f[v].toLowerCase()&&"||"!=f[v]&&"&&"!=f[v])){v>0&&("or"!=f[v-1].toLowerCase()&&"||"!=f[v-1]||(g.operator="or"));var y=o(f[v]);y?(g.field=y.field,g.macro=y.macro,g.comparison=y.comparison,d.push(g)):r||console.error("[casql] Could not parse statement","'"+f[v]+"'")}}d.length>1?(s[_].type="group",s[_].items=d):1==d.length&&(s[_].field=d[0].field,s[_].macro=d[0].macro,s[_].comparison=d[0].comparison)}}for(var h=[],_=0;_<s.length;_++)s[_].value&&h.push(s[_]);return h}function o(e){if(void 0===e)return null;var n=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(n){var o="eq",a="@param"+s,i=l(n[2]);if(">"==i&&(o="gt"),">="==i&&(o="gte"),"<"==i&&(o="lt"),"<="==i&&(o="lte"),"=="==i&&(o="eq"),"<>"!=i&&"!="!=i||(o="ne"),"like"==i.toLowerCase()&&(o="like"),"isnull"==i.toLowerCase()&&(o="null"),"isnotnull"==i.toLowerCase()&&(o="notnull"),"in"==i.toLowerCase()&&(o="in"),"null"!=o&&"notnull"!=o){if(s++,c++,null==u)u=n[3];else if(u!=n[3])return r||console.error("[casql] You can not mix named macros and ?"),null;"@"==n[3][0]&&(a=n[3]),m.push(a)}else a=null;return{field:t(n[1]),comparison:o,macro:a}}return null}var a="(",i=")",u=null;if(void 0===e)return[];var s=0,c=0,m=[];return{statements:n(e=(e=e.replace(/^.*?(WHERE )/i,"")).replace(/(.*?)\s?ORDER BY.*$/i,"$1")),macroType:u,macroCount:c,macros:m}},m=function(e,r){var n,o,a=[],i=new RegExp("(\\[?[a-zA-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(void 0!==e&&null!==e)for(;n=i.exec(e);)!0,o=t(n[1]),3==n.length&&(order=void 0!==n[2]?l(n[2].toLowerCase()):null,order="desc"!=order),a.push([o,order]);return a};window.orderByParser=m;var p=function(){function e(){var e=new SP.CamlQuery,l=p;e.set_viewXml(l),m=u.getItems(e),t.load(m),t.executeQueryAsync(r,function(){i({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:s,viewXml:p,listName:c,error:Array.prototype.slice.call(arguments)}},null)})}function r(){var e,r=m.getEnumerator(),t=[];for(m.get_listItemCollectionPosition()&&(l=x.get_pagingInfo());r.moveNext();)e=r.get_current(),n||(n="PagedPrev=TRUE&Paged=TRUE&p_ID="+e),t.push(e.get_fieldValues());i(null,t,{nextPage:l,prevPage:n})}var t,l,n,o=Array.prototype.slice.call(arguments),a=null,i=null,u=null,c=this.getListName(),m=null,p=this.getXml();return o.length>1?"object"==typeof o[0]&&(a=o[0],"function"==typeof o[1]&&(i=o[1])):1==o.length&&("object"==typeof o[0]?a=o[0]:"function"==typeof o[0]&&(i=o[0])),"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){t=SP.ClientContext.get_current(),null===a&&(a=t.get_web(),u=a.get_lists().getByTitle(c),t.load(u),t.executeQueryAsync(e,function(){i({status:"error",message:"Failed to load list",data:{sql:s,viewXml:p,listName:c,error:Array.prototype.slice.call(arguments)}},null)}))}):i({status:"error",message:"SP is not defined",data:null},null),console.log({web:a,callback:i}),q},f={query:e,limit:[0,-1]},d=!1;3==arguments.length&&1==arguments[2]&&(d=!0),String.prototype.encodeHTML||(String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")});var v={};if(r&&r.length>0){f.originalParam=r;for(h=0;h<r.length;h++)v["@param"+h]=n(r[h]);f.param=v}var g=function(e){var r,l=0,n=-1;(u=e.match(/ LIMIT (\d+,|)(\d+).*$/i))&&(u[0],e=e.substr(0,e.length-u[0].length),""==u[1]?n=parseInt(u[2],10):(l=parseInt(u[1],10),n=parseInt(u[2],10))),(u=e.match(/ ORDER BY (.*?)$/i))&&(r=u[1],e=e.substr(0,e.length-u[0].length));var o,a,i,u=e.match(/^SELECT (.*?) FROM (.*?)(?:\s+(where.*)$|$)/i),s=[],p={statements:[],macroType:null,macroCount:0,macros:[]};if(u&&4==u.length){for(a=u[1].split(","),i=0;i<a.length;i++)a[i]=a[i].replace(/^[\s\[]*|[\s\]]*$/g,""),s.push(a[i]);o=t(u[2]),p=c(u[3],d)}return 1==s.length&&"*"==s[0]&&(s=[]),{listName:o,viewFields:s,where:p.statements,macroType:p.macroType,macroCount:p.macroCount,macros:p.macros,sort:m(r,d),limit:{offset:l,rowLimit:n}}}(e),y="<View>";if(g.viewFields.length>0){y+="<ViewFields>";for(var h=0;h<g.viewFields.length;h++)y+='<FieldRef Name="'+g.viewFields[h].encodeHTML()+'" />';y+="</ViewFields>"}f.macroType=g.macroType,f.macroCount=g.macroCount,f.macros=g.macros;var _=o(g.where),w=function(e){var r,t="";if(void 0!==e){for(r=0;r<e.length;r++)t+='<FieldRef Name="'+e[r][0].encodeHTML()+'"'+(e[r][1]?"":' Ascending="FALSE"')+" />";t&&(t="<OrderBy>"+t+"</OrderBy>")}return t}(g.sort);(_||w)&&(_&&(_="<Where>"+_+"</Where>"),y+="<Query>"+_+w+"</Query>"),-1!=g.limit.rowLimit&&(y+="<RowLimit>"+g.limit.rowLimit+"</RowLimit>"),y+="</View>";var q={getXml:function(){return y},getListName:function(){return g.listName},_properties:f};return void 0!==p&&(q.exec=p),q};camlsql.__proto__.text=function(e){var r;return r={type:"Text",value:e},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(r.multiline=!0),r},camlsql.__proto__.number=function(e){return"number"!=typeof e?(console.error("[camlsql] value was not a number",e),null):{type:"Number",value:e}},camlsql.__proto__.lookup=function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},camlsql.__proto__.datetime=function(e){return"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e}:(console.error("[camlsql] Bad format for datetime value"),null)},camlsql.__proto__.today=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},camlsql.__proto__.month=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",month:!0,value:e}},camlsql.__proto__.guid=function(e){return{type:"Guid",value:e}},camlsql.__proto__.multichoice=function(e){return{type:"MultiChoice",value:e}},camlsql.__proto__.url=function(e){return{type:"URL",value:e}},camlsql.__proto__.prepare=function(){var e=Array.prototype.slice.call(arguments);return e.unshift(null),new(Function.prototype.bind.apply(camlsql,e))};