var camlsql=function(e,r){function l(e){return n(e).replace(/^\[|\]$/g,"")}function n(e){return e.replace(/^\s+|\s+$/g,"")}function o(e){var t,r=0,n=-1;(s=e.match(/^(select\s+)(scope (defaultvalue|recursive|recursiveall|filesonly)\s+)/i))&&(s[3]=s[3].toLowerCase(),"defaultvalue"==s[3]&&(y.viewScope="DefaultValue"),"recursive"==s[3]&&(y.viewScope="Recursive"),"recursiveall"==s[3]&&(y.viewScope="RecursiveAll"),"filesonly"==s[3]&&(y.viewScope="FilesOnly"),e=s[1]+e.substr(s[1].length+s[2].length),console.warn("scope",s[3])),(s=e.match(/ LIMIT (\d+,|)(\d+).*$/i))&&(s[0],e=e.substr(0,e.length-s[0].length),""==s[1]?n=parseInt(s[2],10):(r=parseInt(s[1],10),n=parseInt(s[2],10))),(s=e.match(/ ORDER BY (.*?)$/i))&&(t=s[1],e=e.substr(0,e.length-s[0].length));var o,a,i,s=e.match(/^SELECT (.*?) FROM (.*?)(?:\s+(where.*)$|$)/i),u=[],c={statements:[],macroType:null,macroCount:0,macros:[]};if(s&&4==s.length){for(a=s[1].split(","),i=0;i<a.length;i++)a[i]=a[i].replace(/^[\s\[]*|[\s\]]*$/g,""),u.push(a[i]);o=l(s[2]),c=f(s[3],h)}return 1==u.length&&"*"==u[0]&&(u=[]),{listName:o,viewFields:u,where:c.statements,macroType:c.macroType,macroCount:c.macroCount,macros:c.macros,sort:g(t,h),limit:{offset:r,rowLimit:n}}}function a(e){var t=null;if(null==e)return null;if(null!==e&&e.constructor===Array){t=[];for(var r=0;r<e.length;r++)t.push(a(e[r]))}else if("string"==typeof e)t=camlsql.text(e);else if("number"==typeof e)t=camlsql.number(e);else if("object"==typeof e&&"undefined"!==e.type)return e;return t}function i(){if(T=o(e),q="<View",y.viewScope&&(q+=' Scope="'+y.viewScope.encodeHTML()+'"'),q+=">",T.viewFields.length>0){q+="<ViewFields>";for(var t=0;t<T.viewFields.length;t++)q+='<FieldRef Name="'+T.viewFields[t].encodeHTML()+'" />';q+="</ViewFields>"}y.macroType=T.macroType,y.macroCount=T.macroCount,y.macros=T.macros;var r=u(T.where),l=s(T.sort);(r||l)&&(r&&(r="<Where>"+r+"</Where>"),q+="<Query>"+r+l+"</Query>"),-1!=T.limit.rowLimit&&(q+="<RowLimit>"+T.limit.rowLimit+"</RowLimit>"),q+="</View>"}function s(e){var t,r="",l="";if(void 0!==e){for(t=0;t<e.length;t++)e[t][2]&&(l=' Type="'+e[t][2].encodeHTML()+'"'),r+='<FieldRef Name="'+e[t][0].encodeHTML()+'"'+l+(e[t][1]?"":' Ascending="FALSE"')+" />";r&&(r="<OrderBy>"+r+"</OrderBy>")}return r}function u(e){var t="";if(!e)return"";if(e.length>1){var r="and"==e[1].operator?"And":"Or";return t+=c(e[0]),t+=u(e.slice(1)),"<"+r+">"+t+"</"+r+">"}return 1==e.length&&(t+=c(e[0])),t}function c(e){var t="";if("statement"==e.type){var r=_[e.macro];if(console.warn("",e.macro,e),"null"!==e.comparison&&"notnull"!==e.comparison&&void 0===r)return t+="<casql:Error>"+("Parameter not found ("+e.macro+")").encodeHTML()+"</casql:Error>",h||console.error("[casql] Parameter not found",e.macro),t;var l={eq:"Eq",gt:"Gt",gte:"Geq",lte:"Leq",lt:"Lt",ne:"Neq"};if(void 0!==l[e.comparison])t+="<"+(n=l[e.comparison])+">",t+=p(e,r),t+="</"+n+">";else if("in"==e.comparison)t+="<IsNull>",t+=p(e,r),t+="</IsNull>";else if("null"==e.comparison)t+="<IsNull>",t+='<FieldRef Name="'+e.field.encodeHTML()+'" />',t+="</IsNull>";else if("notnull"==e.comparison)t+="<IsNotNull>",t+='<FieldRef Name="'+e.field.encodeHTML()+'" />',t+="</IsNotNull>";else if("like"==e.comparison)if("Text"==r.type){var n="Contains",o=null;0===r.value.indexOf("%")&&"%"===r.value[r.value.length-1]?o=r.value.replace(/^%?|%?$/g,""):0===r.value.indexOf("%")?(console.warn("[casql] SharePoint does not support an 'EndsWith' statement. Contains will be used instead. (Field '"+e.field+"')"),o=r.value.replace(/^%?/,"")):r.value.indexOf("%")===r.value.length-1&&(o=r.value.replace(/%?$/,""),n="BeginsWith"),t+="<"+n+">",t+=p(e,r,o),t+="</"+n+">"}else t+="<casql:Error>LIKE statements must use a text parameter. "+r.type+" was used.</casql:Error>";else t+="<NOT_IMPLEMENTED>"+e.comparison+"</NOT_IMPLEMENTED>"}else t+=u(e.items);return t}function m(e,t,r){var l="",n="";return"DateTime"==t.type?(1==t.includeTime&&(n+=' IncludeTimeValue="TRUE"'),!0===t.today?(l="<Today",r&&(l+=' OffsetDays="'+r+'"'),l+=" />"):!0===t.isNow?l+="<Now />":l+=r.encodeHTML()):"Text"==t.type||"Guid"==t.type?!0===t.multiline?(l="<<![CDATA[",l+=r,l+="]]>"):l+=r.encodeHTML():"Number"==t.type&&(l+=r),l='<Value Type="'+t.type+'"'+n+">"+l+"</Value>"}function p(e,t,r){var l="",n="",o=void 0!==r&&null!==r?r:t?t.value:null;if("in"==e.comparison){l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="<Values>";for(var a=0;a<t.length;a++)l+=m(e,t[a],t[a].value);return l+="</Values>"}return n=m(e,t,o),l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+=n}function d(){return e}var f=function(e,t){function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var l=null,s=null,u=[],c=0;for(_=0;_<e.length;_++)e[_]==a?(0==c&&(_>0&&u.push(e.substring(0,_)),l=_,s=null),c++):e[_]==i&&null!==l&&0==--c&&(u.push(r(e.substring(l,_+1)).replace(/^\(|\)$/g,"")),s=_+1);null!=s?u.push(r(e.substring(s))):0==u.length&&null==l&&null==s&&u.push(r(e));for(_=0;_<u.length;_++){var m="and";if(u[_].match(/^\s*(\|\||(or))\s*/i)&&(m="or"),u[_].match(/\s*[\|\||(or)]\s*$/gi)&&_<u.length-1&&(u[_+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(u[_+1]="or "+u[_+1])),u[_]=u[_].replace(/\s*(\&\&|and)\s*$/i,""),u[_]=u[_].replace(/\s*(\|\||or)\s*$/i,""),u[_]=u[_].replace(/^\s*(\&\&|and)\s*/i,""),u[_]=u[_].replace(/^\s*(\|\||or)\s*/i,""),u[_]={type:"statement",value:u[_],operator:m},-1!==u[_].value.indexOf(a)){var p=n(u[_].value);p.length>1&&(u[_].type="group",u[_].items=p)}else{var d=u[_].value.split(/ (\|\||or|and|\&\&) /i);u[_].type="statement";for(var f=[],g=0;g<d.length;g++){var v={type:"statement",operator:"and"};if(""!=r(d[g])&&("and"!=d[g].toLowerCase()&&"or"!=d[g].toLowerCase()&&"||"!=d[g]&&"&&"!=d[g])){g>0&&("or"!=d[g-1].toLowerCase()&&"||"!=d[g-1]||(v.operator="or"));var y=o(d[g]);y?(v.field=y.field,v.macro=y.macro,v.comparison=y.comparison,f.push(v)):t||console.error("[casql] Could not parse statement","'"+d[g]+"'")}}f.length>1?(u[_].type="group",u[_].items=f):1==f.length&&(u[_].field=f[0].field,u[_].macro=f[0].macro,u[_].comparison=f[0].comparison)}}for(var h=[],_=0;_<u.length;_++)u[_].value&&h.push(u[_]);return h}function o(e){if(void 0===e)return null;var n=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(n){var o="eq",a="@param"+u,i=r(n[2]);if(">"==i&&(o="gt"),">="==i&&(o="gte"),"<"==i&&(o="lt"),"<="==i&&(o="lte"),"=="==i&&(o="eq"),"<>"!=i&&"!="!=i||(o="ne"),"like"==i.toLowerCase()&&(o="like"),"isnull"==i.toLowerCase()&&(o="null"),"isnotnull"==i.toLowerCase()&&(o="notnull"),"in"==i.toLowerCase()&&(o="in"),"null"!=o&&"notnull"!=o){if(u++,c++,null==s)s=n[3];else if(s!=n[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==n[3][0]&&(a=n[3]),m.push(a)}else a=null;return{field:l(n[1]),comparison:o,macro:a}}return null}var a="(",i=")",s=null;if(void 0===e)return[];var u=0,c=0,m=[];return{statements:n(e=(e=e.replace(/^.*?(WHERE )/i,"")).replace(/(.*?)\s?ORDER BY.*$/i,"$1")),macroType:s,macroCount:c,macros:m}},g=function(e,r){var o,a,i,s,u=[],c=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(void 0!==e&&null!==e)for(;o=c.exec(e);){if(s=!0,i=null,o[1].indexOf(":")>0){if(t=o[1].split(":"),2!=t.length)return[];switch(t[0]=t[0].toLowerCase(),t[0]){case"datetime":t[0]="DateTime";break;case"text":t[0]="Text";break;case"number":t[0]="Number";break;case"datetime":t[0]="DateTime"}i=t[0],o[1]=t[1]}a=l(o[1]),3==o.length&&(order=void 0!==o[2]?n(o[2].toLowerCase()):null,s="desc"!=order),u.push([a,s,i])}return u};window.orderByParser=g;var v=function(){function e(){var e=new SP.CamlQuery,l=p;e.set_viewXml(l),console.log("camlQuery",e),m=u.getItems(e),r.load(m),r.executeQueryAsync(t,function(){s({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:d,viewXml:p,listName:c,error:Array.prototype.slice.call(arguments)}},null)})}function t(){var e,t=m.getEnumerator(),r=[],o=m.get_listItemCollectionPosition();for(o&&(l=o.get_pagingInfo());t.moveNext();)e=t.get_current(),n||(n="PagedPrev=TRUE&Paged=TRUE&p_ID="+encodeURIComponent(e.get_id())),r.push(e.get_fieldValues());s(null,r,{nextPage:l,prevPage:n})}var r,l,n,o=Array.prototype.slice.call(arguments),a=null,s=null,u=null,c=this.getListName(),m=null,p=this.getXml();return i(),o.length>1?"object"==typeof o[0]&&(a=o[0],"function"==typeof o[1]&&(s=o[1])):1==o.length&&("object"==typeof o[0]?a=o[0]:"function"==typeof o[0]&&(s=o[0])),"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){r=SP.ClientContext.get_current(),null===a&&(a=r.get_web(),u=a.get_lists().getByTitle(c),r.load(u),r.executeQueryAsync(e,function(){s({status:"error",message:"Failed to load list",data:{sql:d,viewXml:p,listName:c,error:Array.prototype.slice.call(arguments)}},null)}))}):s({status:"error",message:"SP is not defined",data:null},null),console.log({web:a,callback:s}),L},y={query:e,limit:[0,-1],viewScope:null},h=!1;3==arguments.length&&1==arguments[2]&&(h=!0),String.prototype.encodeHTML||(String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")});var _={};if(r&&r.length>0){y.originalParam=r;for(var w=0;w<r.length;w++)_["@param"+w]=a(r[w]);y.param=_}var T,q="",L={getXml:function(){return i(),q},getListName:function(){return T.listName},_properties:y};return void 0!==v&&(L.exec=v),i(),L};camlsql.__proto__._padString=function(e,t){for(var r=String(e);r.length<(t||2);)r="0"+r;return r},camlsql.__proto__.text=function(e){var t;return t={type:"Text",value:e},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t},camlsql.__proto__.number=function(e){return"number"!=typeof e?(console.error("[camlsql] value was not a number",e),null):{type:"Number",value:e}},camlsql.__proto__.lookup=function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},camlsql.__proto__.now=function(e){return{type:"DateTime",isNow:!0,includeTime:1==e}},camlsql.__proto__.date=function(){var e,t=Array.prototype.slice.call(arguments);return e=camlsql.datetime.apply(this,t),e.includeTime=!1,e},camlsql.__proto__.datetime=function(e){if("string"==typeof e)if("month start"==e)e=(t=new Date).getFullYear()+"-"+camlsql._padString(t.getMonth()+1)+"-01T00:00:00Z";else if("month end"==e){var t=new Date,r=new Date(t.getFullYear(),t.getMonth()+1,0);e=r.getFullYear()+"-"+camlsql._padString(r.getMonth()+1)+"-"+camlsql._padString(r.getDate())+"T23:59:59Z"}else"this morning"==e?e=(t=new Date).getFullYear()+"-"+camlsql._padString(t.getMonth()+1)+"-"+camlsql._padString(t.getDate())+"T00:00:00Z":"tonight"==e&&(e=(t=new Date).getFullYear()+"-"+camlsql._padString(t.getMonth()+1)+"-"+camlsql._padString(t.getDate())+"T23:59:59Z");return"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e,includeTime:!0}:(console.error("[camlsql] Bad format for datetime value"),null)},camlsql.__proto__.today=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},camlsql.__proto__.guid=function(e){return{type:"Guid",value:e}},camlsql.__proto__.multichoice=function(e){return{type:"MultiChoice",value:e}},camlsql.__proto__.url=function(e){return{type:"URL",value:e}},camlsql.__proto__.prepare=function(){var e=Array.prototype.slice.call(arguments);return e.unshift(null),new(Function.prototype.bind.apply(camlsql,e))};