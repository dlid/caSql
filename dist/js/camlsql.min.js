var camlsql=function(e,l){function t(e){return r(e).replace(/^\[|\]$/g,"")}function r(e){return e.replace(/^\s+|\s+$/g,"")}function n(e){var l=null;if(null!==e&&e.constructor===Array){l=[];for(var t=0;t<e.length;t++)l.push(n(e[t]))}else"string"==typeof e?l=camlsql.text(e):"number"==typeof e&&(l=camlsql.number(e));return l}function o(e){var l="";if(e.length>1){var t="and"==e[1].operator?"And":"Or";return l+=a(e[0]),l+=o(e.slice(1)),"<"+t+">"+l+"</"+t+">"}return 1==e.length&&(l+=a(e[0])),l}function a(e){var l="";if("statement"==e.type){var t=p[e.macro];if("null"!==e.comparison&&"notnull"!==e.comparison&&void 0===t)return l+="<casql:Error>"+("Parameter not found ("+e.macro+")").encodeHTML()+"</casql:Error>",console.error("[casql] Parameter not found",e.macro),l;if("eq"==e.comparison)l+="<Eq>",l+=i(e,t),l+="</Eq>";else if("gte"==e.comparison)l+="<Geq>",l+=i(e,t),l+="</Geq>";else if("lte"==e.comparison)l+="<Leq>",l+=i(e,t),l+="</Leq>";else if("lt"==e.comparison)l+="<Lt>",l+=i(e,t),l+="</Lt>";else if("ne"==e.comparison)l+="<Neq>",l+=i(e,t),l+="</Neq>";else if("null"==e.comparison)l+="<IsNull>",l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="</IsNull>";else if("notnull"==e.comparison)l+="<IsNotNull>",l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="</IsNotNull>";else if("like"==e.comparison){var r="Contains",n=null;0===t.value.indexOf("%")&&t.value.indexOf("%")===t.value.length-1?n=t.value.replace(/^%?|%?$/g,""):0===t.value.indexOf("%")?(console.warn("[casql] SharePoint does not support an 'EndsWith' statement. Contains will be used instead. (Field '"+e.field+"')"),n=t.value.replace(/^%?/,"")):t.value.indexOf("%")===t.value.length-1&&(n=t.value.replace(/%?$/,""),r="BeginsWith"),l+="<"+r+">",l+=i(e,t,n),l+="</"+r+">"}else l+="<NOT_IMPLEMENTED>"+e.comparison+"</NOT_IMPLEMENTED>"}else l+=o(e.items);return l}function i(e,l,t){var r="",n="",o=void 0!==t&&null!==t?t:l.value;return"DateTime"==l.type?!0===l.today&&(n="<Today",o&&(n+=' OffsetDays="'+o+'"'),n+=" />"):"Text"==l.type&&(!0===l.multiline?(n="<<![CDATA[",n+=o,n+="]]>"):n+=o.encodeHTML()),r+='<FieldRef Name="'+e.field.encodeHTML()+'" />',r+='<Value Type="'+l.type+'">'+n+"</Value>"}function u(){return e}var s=function(e){function l(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){var t=null,i=null,u=[],s=0;for(h=0;h<e.length;h++)e[h]==o?(0==s&&(h>0&&u.push(e.substring(0,h)),t=h,i=null),s++):e[h]==a&&null!==t&&0==--s&&(u.push(l(e.substring(t,h+1)).replace(/^\(|\)$/g,"")),i=h+1);null!=i?u.push(l(e.substring(i))):0==u.length&&null==t&&null==i&&u.push(l(e));for(h=0;h<u.length;h++){var c="and";if(u[h].match(/^\s*(\|\||(or))\s*/i)&&(c="or"),u[h].match(/\s*[\|\||(or)]\s*$/gi)&&h<u.length-1&&(u[h+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(u[h+1]="or "+u[h+1])),u[h]=u[h].replace(/\s*(\&\&|and)\s*$/i,""),u[h]=u[h].replace(/\s*(\|\||or)\s*$/i,""),u[h]=u[h].replace(/^\s*(\&\&|and)\s*/i,""),u[h]=u[h].replace(/^\s*(\|\||or)\s*/i,""),u[h]={type:"statement",value:u[h],operator:c},-1!==u[h].value.indexOf(o)){var p=r(u[h].value);p.length>1&&(u[h].type="group",u[h].items=p)}else{var f=u[h].value.split(/ (\|\||or|and|\&\&) /i);u[h].type="statement";for(var m=[],d=0;d<f.length;d++){var v={type:"statement",operator:"and"};if(""!=l(f[d])&&("and"!=f[d].toLowerCase()&&"or"!=f[d].toLowerCase()&&"||"!=f[d]&&"&&"!=f[d])){d>0&&("or"!=f[d-1].toLowerCase()&&"||"!=f[d-1]||(v.operator="or"));var g=n(f[d]);g?(v.field=g.field,v.macro=g.macro,v.comparison=g.comparison,m.push(v)):console.error("[casql] Could not parse statement","'"+f[d]+"'")}}m.length>1?(u[h].type="group",u[h].items=m):1==m.length&&(u[h].field=m[0].field,u[h].macro=m[0].macro,u[h].comparison=m[0].comparison)}}for(var y=[],h=0;h<u.length;h++)u[h].value&&y.push(u[h]);return y}function n(e){if(void 0===e)return null;var l=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(l){var r="eq",n="@param"+u;if(">"==l[2]&&(r="gt"),">="==l[2]&&(r="gte"),"<"==l[2]&&(r="lt"),"<="==l[2]&&(r="lte"),"=="==l[2]&&(r="eq"),"<>"!=l[2]&&"!="!=l[2]||(r="ne"),"like"==l[2].toLowerCase()&&(r="like"),"isnull"==l[2].toLowerCase()&&(r="null"),"isnotnull"==l[2].toLowerCase()&&(r="notnull"),"in"==l[2].toLowerCase()&&(r="in"),"null"!=r&&"notnull"!=r){if(u++,null==i)i=l[3];else if(i!=l[3])return console.error("[casql] You can not mix named macros and ?"),null;"@"==l[3][0]&&(n=l[3])}else n=null;return{field:t(l[1]),comparison:r,macro:n}}return null}var o="(",a=")",i=null;if(void 0===e)return[];var u=0;return r(e=(e=e.replace(/^.*?(WHERE )/i,"")).replace(/(.*?)\s?ORDER BY.*$/i,"$1"))},c=function(){function e(){var e=new SP.CamlQuery,r=c;e.set_viewXml(r),s=companiesList.getItems(e),t.load(allCompanies),t.executeQueryAsync(l,function(){o({status:"error",message:"Error executing the SP.CamlQuery",data:{sql:u,viewXml:c,listName:i,error:Array.prototype.slice.call(arguments)}},null)})}function l(){for(var e=s.getEnumerator();e.moveNext();)e.get_current()}var t,r=Array.prototype.slice.call(arguments),n=null,o=null,a=null,i=this.getListName(),s=null,c=this.getXml();return r.length>1?"object"==typeof r[0]&&(n=r[0],"function"==typeof r[1]&&(o=r[1])):1==r.length&&("object"==typeof r[0]?n=r[0]:"function"==typeof r[0]&&(o=r[0])),"undefined"!=typeof SP?SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){t=SP.ClientContext.get_current(),null===n&&(n=t.get_web(),a=oWeb.get_lists().getByTitle(i),t.load(a),t.executeQueryAsync(e,function(){o({status:"error",message:"Failed to load list",data:{sql:u,viewXml:c,listName:i,error:Array.prototype.slice.call(arguments)}},null)}))}):o({status:"error",message:"SP is not defined",data:null},null),console.log({web:n,callback:o}),this};String.prototype.encodeHTML||(String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")});var p={};if(l&&l.length>0)for(d=0;d<l.length;d++)p["@param"+d]=n(l[d]);console.log("PARAMS",p);var f=function(e){var l,r,n,o=e.match(/^SELECT (.*?) FROM (.*?)(?:\s(.*)$|$)/i),a=[];if(o&&4==o.length){for(r=o[1].split(","),n=0;n<r.length;n++)r[n]=r[n].replace(/^[\s\[]*|[\s\]]*$/g,""),a.push(r[n]);l=t(o[2])}return 1==a.length&&"*"==a[0]&&(a=[]),{listName:l,viewFields:a,where:s(o[3])}}(e),m="<View>";if(f.viewFields.length>0){m+="<ViewFields>";for(var d=0;d<f.viewFields.length;d++)m+='<FieldRef Name="'+f.viewFields[d].encodeHTML()+'" />';m+="</ViewFields>"}var v=o(f.where);v&&(m+="<Query><Where>"+v+"</Where></Query>"),m+="</View>";var g={getXml:function(){return m},getListName:function(){return f.listName}};return void 0!==c&&(g.exec=c),g};camlsql.__proto__.text=function(e){var l;return l={type:"Text",value:e},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(l.multiline=!0),l},camlsql.__proto__.number=function(e){return"number"!=typeof e?(console.error("[camlsql] value was not a number",e),null):{type:"Number",value:e}},camlsql.__proto__.lookup=function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},camlsql.__proto__.datetime=function(e){return"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e}:(console.error("[camlsql] Bad format for datetime value"),null)},camlsql.__proto__.today=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},camlsql.__proto__.month=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",month:!0,value:e}},camlsql.__proto__.guid=function(e){return{type:"Guid",value:e}},camlsql.__proto__.multichoice=function(e){return{type:"MultiChoice",value:e}},camlsql.__proto__.url=function(e){return{type:"URL",value:e}},camlsql.__proto__.prepare=function(){var e=Array.prototype.slice.call(arguments);return e.unshift(null),new(Function.prototype.bind.apply(camlsql,e))};