var caSql=function(e,l){function r(e){var l="";if(e.length>1){var t="and"==e[1].operator?"And":"Or";return l+=n(e[0]),l+=r(e.slice(1)),"<"+t+">"+l+"</"+t+">"}return 1==e.length&&(l+=n(e[0])),l}function n(e){var l="";if("statement"==e.type){var n=a[e.macro];if("null"!==e.comparison&&"notnull"!==e.comparison&&void 0===n)return l+="<casql:Error>"+("Parameter not found ("+e.macro+")").encodeHTML()+"</casql:Error>",console.error("[casql] Parameter not found",e.macro),l;if("eq"==e.comparison)l+="<Eq>",l+=t(e,n),l+="</Eq>";else if("gte"==e.comparison)l+="<Geq>",l+=t(e,n),l+="</Geq>";else if("lte"==e.comparison)l+="<Leq>",l+=t(e,n),l+="</Leq>";else if("lt"==e.comparison)l+="<Lt>",l+=t(e,n),l+="</Lt>";else if("ne"==e.comparison)l+="<Neq>",l+=t(e,n),l+="</Neq>";else if("null"==e.comparison)l+="<IsNull>",l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="</IsNull>";else if("notnull"==e.comparison)l+="<IsNotNull>",l+='<FieldRef Name="'+e.field.encodeHTML()+'" />',l+="</IsNotNull>";else if("like"==e.comparison){var o="Contains",i=null;0===n.value.indexOf("%")&&n.value.indexOf("%")===n.value.length-1?i=n.value.replace(/^%?|%?$/g,""):0===n.value.indexOf("%")?(console.warn("[casql] SharePoint does not support an 'EndsWith' statement. Contains will be used instead. (Field '"+e.field+"')"),i=n.value.replace(/^%?/,"")):n.value.indexOf("%")===n.value.length-1&&(i=n.value.replace(/%?$/,""),o="BeginsWith"),l+="<"+o+">",l+=t(e,n,i),l+="</"+o+">"}else l+="<NOT_IMPLEMENTED>"+e.field+"</NOT_IMPLEMENTED>"}else l+=r(e.items);return l}function t(e,l,r){var n="",t="",o=void 0!==r&&null!==r?r:l.value;return"DateTime"==l.type?!0===l.today&&(t="<Today",o&&(t+=' OffsetDays="'+o+'"'),t+=" />"):"Text"==l.type&&(!0===l.multiline?(t="<<![CDATA[",t+=o,t+="]]>"):t+=o.encodeHTML()),n+='<FieldRef Name="'+e.field.encodeHTML()+'" />',n+='<Value Type="'+l.type+'">'+t+"</Value>"}var o=function(e){function l(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){return l(e).replace(/^\[|\]$/g,"")}function n(e){var r=null,i=null,u=[],s=0;for(y=0;y<e.length;y++)e[y]==o?(0==s&&(y>0&&u.push(e.substring(0,y)),r=y,i=null),s++):e[y]==a&&null!==r&&0==--s&&(u.push(l(e.substring(r,y+1)).replace(/^\(|\)$/g,"")),i=y+1);null!=i?u.push(l(e.substring(i))):0==u.length&&null==r&&null==i&&u.push(l(e));for(y=0;y<u.length;y++){var c="and";if(u[y].match(/^\s*(\|\||(or))\s*/i)&&(c="or"),u[y].match(/\s*[\|\||(or)]\s*$/gi)&&y<u.length-1&&(u[y+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(u[y+1]="or "+u[y+1])),u[y]=u[y].replace(/\s*(\&\&|and)\s*$/i,""),u[y]=u[y].replace(/\s*(\|\||or)\s*$/i,""),u[y]=u[y].replace(/^\s*(\&\&|and)\s*/i,""),u[y]=u[y].replace(/^\s*(\|\||or)\s*/i,""),u[y]={type:"statement",value:u[y],operator:c},-1!==u[y].value.indexOf(o)){var p=n(u[y].value);p.length>1&&(u[y].type="group",u[y].items=p)}else{var d=u[y].value.split(/ (\|\||or|and|\&\&) /i);u[y].type="statement";for(var f=[],m=0;m<d.length;m++){var v={type:"statement",operator:"and"};if(""!=l(d[m])&&("and"!=d[m].toLowerCase()&&"or"!=d[m].toLowerCase()&&"||"!=d[m]&&"&&"!=d[m])){m>0&&("or"!=d[m-1].toLowerCase()&&"||"!=d[m-1]||(v.operator="or"));var g=t(d[m]);g?(v.field=g.field,v.macro=g.macro,v.comparison=g.comparison,f.push(v)):console.error("[casql] Could not parse statement","'"+d[m]+"'")}}f.length>1?(u[y].type="group",u[y].items=f):1==f.length&&(u[y].field=f[0].field,u[y].macro=f[0].macro,u[y].comparison=f[0].comparison)}}for(var h=[],y=0;y<u.length;y++)u[y].value&&h.push(u[y]);return h}function t(e){if(void 0===e)return null;var l=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull)\s*(\?|@[a-z]+)/i);if(l){var n="eq",t="@param"+u;if(console.warn("MATCH",e,l),">"==l[2]&&(n="gt"),">="==l[2]&&(n="gte"),"<"==l[2]&&(n="lt"),"<="==l[2]&&(n="lte"),"=="==l[2]&&(n="eq"),"<>"!=l[2]&&"!="!=l[2]||(n="ne"),"like"==l[2].toLowerCase()&&(n="like"),"isnull"==l[2].toLowerCase()&&(n="null"),"isnotnull"==l[2].toLowerCase()&&(n="notnull"),"null"!=n&&"notnull"!=n){if(u++,null==i)i=l[3];else if(i!=l[3])return console.error("[casql] You can not mix named macros and ?"),null;"@"==l[3][0]&&(t=l[3])}else t=null;return{field:r(l[1]),comparison:n,macro:t}}return null}var o="(",a=")",i=null;if(void 0===e)return[];var u=0;return n(e=(e=e.replace(/^.*?(WHERE )/i,"")).replace(/(.*?)\s?ORDER BY.*$/i,"$1"))};String.prototype.encodeHTML||(String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")});var a={};if(l&&l.length>0)for(s=0;s<l.length;s++)"string"==typeof l[s]?l[s]=caSql.text(l[s]):"number"==typeof l[s]&&(l[s]=caSql.number(l[s])),a["@param"+s]=l[s];var i=function(e){var l,r,n=e.match(/^SELECT (.*?) FROM (.*?)(?:\s(.*)$|$)/i),t=[];if(n&&4==n.length){for(l=n[1].split(","),r=0;r<l.length;r++)l[r]=l[r].replace(/^[\s\[]*|[\s\]]*$/g,""),t.push(l[r]);n[2]}return 1==t.length&&"*"==t[0]&&(t=[]),{viewFields:t,where:o(n[3])}}(e),u="<View>";if(i.viewFields.length>0){u+="<ViewFields>";for(var s=0;s<i.viewFields.length;s++)u+='<FieldRef Name="'+i.viewFields[s].encodeHTML()+'" />';u+="</ViewFields>"}var c=r(i.where);return c&&(u+="<Query><Where>"+c+"</Where></Query>"),u+="</View>",console.log(e,l,i),{getXml:function(){return u}}};caSql.__proto__.text=function(e){var l;return l={type:"Text",value:e},!0===(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(l.multiline=!0),l},caSql.__proto__.number=function(e){return"number"!=typeof e?(console.error("[casql] value was not a number",e),null):{type:"Number",value:e}},caSql.__proto__.lookup=function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},caSql.__proto__.datetime=function(e){return"string"!=typeof e?(console.error("[casql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e}:(console.error("[casql] Bad format for datetime value"),null)},caSql.__proto__.today=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[casql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},caSql.__proto__.month=function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[casql] Bad offset value for 'today'",e),null):{type:"DateTime",month:!0,value:e}},caSql.__proto__.guid=function(e){return{type:"Guid",value:e}},caSql.__proto__.multichoice=function(e){return{type:"MultiChoice",value:e}},caSql.__proto__.url=function(e){return{type:"URL",value:e}};