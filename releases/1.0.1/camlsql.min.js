!function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.camlsql=t()}(this,function(){"use strict";function e(e){var n;return"string"==typeof e&&("month start"==e?(new Date,e=d.getFullYear()+"-"+t(d.getMonth()+1)+"-01T00:00:00Z"):"month end"==e?(new Date,e=(n=new Date(d.getFullYear(),d.getMonth()+1,0)).getFullYear()+"-"+t(n.getMonth()+1)+"-"+t(n.getDate())+"T23:59:59Z"):"this morning"==e?(new Date,e=d.getFullYear()+"-"+t(d.getMonth()+1)+"-"+t(d.getDate())+"T00:00:00Z"):"tonight"==e&&(new Date,e=d.getFullYear()+"-"+t(d.getMonth()+1)+"-"+t(d.getDate())+"T23:59:59Z")),"string"!=typeof e?(console.error("[camlsql] Bad type for datetime value"),null):"string"!=typeof e||e.match(/^\d{4}-\d\d-\d\d$/)||e.match(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\dZ$/)?{type:"DateTime",value:e,includeTime:!0}:(console.error("[camlsql] Bad format for datetime value"),null)}function t(e,t){for(var n=String(e);n.length<(t||2);)n="0"+n;return n}function n(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){return n(e).replace(/^\[|\]$/g,"")}function l(e){var t;(t=e.query.match(/\sLIMIT\s(\d+).*$/i))&&(e.query=e.query.substr(0,e.query.length-t[0].length),e.rowLimit=parseInt(t[1],10))}function o(e){var t,n=[],l=e.query.match(/^SELECT\s(.*?)\sFROM\s(.*?)(?:\s+(where.*)$|$)/i);if(l)if(4==l.length){for(n=a(l[1]),t=0;t<n.length;t++)n[t].match(/^[a-z:A-Z_\\d]+$/)||console.warn&&console.warn("[camlsql] Doubtful field name: "+n[t]);e.fields=n,r(l[2]),e.query=l[3]}else e.query=""}function a(e){var t,n=[],l=e.split(",");for(t=0;t<l.length;t++)l[t]=r(l[t]),n.push(l[t]);return 1==n.length&&"*"==n[0]&&(n=[]),n}function u(e,t){var l,o,a,u,s,i,c=[],d=e.query,f=new RegExp("(\\[?[a-z:A-Z_\\d]+?\\]?)(\\,\\s+|\\s+asc|\\s+desc|$)","ig");if(i=d.match(/\sORDER\sBY\s(.*?)$/i)){if(u=i[1],d=d.substr(0,d.length-i[0].length),void 0!==u&&null!==u)for(;l=f.exec(u);){if(s=!0,a=null,l[1].indexOf(":")>0){if(!(2==(i=l[1].split(":")).length&&i[0].length>0))return[];switch(i[0]=i[0].toLowerCase(),i[0]){case"datetime":i[0]="DateTime";break;case"text":i[0]="Text";break;case"number":i[0]="Number";break;case"datetime":i[0]="DateTime"}a=i[0],l[1]=i[1]}else console.error&&console.error("[camlsql] Error in ORDER BY statement: "+l[1]);o=r(l[1]),3==l.length&&(s="desc"!=(void 0!==l[2]?n(l[2].toLowerCase()):null)),c.push([o,s,a])}e.sort=c}}function s(e){var t,n,r=e.query;if(t=r.match(/^(select\s+)(scope\s+([a-z]+)\s+)/i)){switch(t[3]=t[3].toLowerCase(),t[3]){case"defaultvalue":n="DefaultValue";break;case"recursive":n="Recursive";break;case"recursiveall":n="RecursiveAll";break;case"filesonly":n="FilesOnly"}!n&&console.error&&console.error("[camlsql] Unknown scope '"+t[3]+"'"),e.viewScope=n,e.query=t[1]+r.substr(t[1].length+t[2].length)}}window.parseSqlQuery=function(e,t){var n,r={query:e,rowLimit:0,fields:[],sort:[],viewScope:null,macros:[],statements:[]};return s(r),l(r),u(r),o(r),n=i(r.query),r.statements=n.statements,r.macros=n.macros,r.query=e,r};var i=function(e,t){function n(e){return e.replace(/^\s+|\s+$/g,"")}function l(e){var r,s,i,c,d,f,m,p,h,g=null,y=null,v=[],w=0;for(r=0;r<e.length;r++)e[r]==a?(0==w&&(r>0&&v.push(e.substring(0,r)),g=r,y=null),w++):e[r]==u&&null!==g&&0==--w&&(v.push(n(e.substring(g,r+1)).replace(/^\(|\)$/g,"")),y=r+1);for(null!=y?v.push(n(e.substring(y))):0==v.length&&null==g&&null==y&&v.push(n(e)),r=0;r<v.length;r++)if(s="and",v[r].match(/^\s*(\|\||(or))\s*/i)&&(s="or"),v[r].match(/\s*(?:\|\||(or))\s*$/gi)&&r<v.length-1&&(v[r+1].match(/^\s*(\|\||or|and|\&\&)/gi)||(v[r+1]="or "+v[r+1])),v[r]=v[r].replace(/\s*(\&\&|and)\s*$/i,""),v[r]=v[r].replace(/\s*(\|\||or)\s*$/i,""),v[r]=v[r].replace(/^\s*(\&\&|and)\s*/i,""),v[r]=v[r].replace(/^\s*(\|\||or)\s*/i,""),v[r]={type:"statement",value:v[r],operator:s},-1!==v[r].value.indexOf(a))(c=l(v[r].value)).length>1&&(v[r].type="group",v[r].items=c);else{for(i=v[r].value.split(/ (\|\||or|and|\&\&) /i),v[r].type="statement",d=[],f=0;f<i.length;f++)m={type:"statement",operator:"and"},""!=n(i[f])&&"and"!=i[f].toLowerCase()&&"or"!=i[f].toLowerCase()&&"||"!=i[f]&&"&&"!=i[f]&&(f>0&&("or"!=i[f-1].toLowerCase()&&"||"!=i[f-1]||(m.operator="or")),(p=o(i[f]))?(m.field=p.field,m.macro=p.macro,m.comparison=p.comparison,d.push(m)):t||console.error("[casql] Could not parse statement","'"+i[f]+"'"));d.length>1?(v[r].type="group",v[r].items=d):1==d.length&&(v[r].field=d[0].field,v[r].macro=d[0].macro,v[r].comparison=d[0].comparison)}for(h=[],r=0;r<v.length;r++)v[r].value&&h.push(v[r]);return h}function o(e){if(void 0===e)return null;var l=(e=(e=e.replace(/ is not null/i," isnotnull ?")).replace(/ is null/i," isnull ?")).match(/(.*)\s*(<>|>=|[^<]>|<=|<[^>]|[^<>]=|like|isnull|isnotnull|in)\s*(\?|@[a-z]+)/i);if(l){var o="eq",a="@param"+i,u=n(l[2]);if(">"==u&&(o="gt"),">="==u&&(o="gte"),"<"==u&&(o="lt"),"<="==u&&(o="lte"),"=="==u&&(o="eq"),"<>"!=u&&"!="!=u||(o="ne"),"like"==u.toLowerCase()&&(o="like"),"isnull"==u.toLowerCase()&&(o="null"),"isnotnull"==u.toLowerCase()&&(o="notnull"),"in"==u.toLowerCase()&&(o="in"),"null"!=o&&"notnull"!=o){if(i++,c++,null==s)s=l[3];else if(s!=l[3])return t||console.error("[casql] You can not mix named macros and ?"),null;"@"==l[3][0]&&(a=l[3]),d.push(a)}else a=null;return{field:r(l[1]),comparison:o,macro:a}}return null}var a="(",u=")",s=null;if(void 0===e)return[];var i=0,c=0,d=[];return{statements:l(e=(e=e.replace(/^.*?(WHERE\s)/i,"")).replace(/(.*?)\s?ORDER\sBY.*$/i,"$1")),macroType:s,macroCount:c,macros:d}};return{prepare:function(e,t){return new CamlSqlQuery(e,t)},text:function(e){var t;return t={type:"Text",value:e},!0==(-1!=e.indexOf("\n")||-1!==e.indexOf("\r"))&&(t.multiline=!0),t},guid:function(e){return{type:"Guid",value:e}},number:function(e){return"number"!=typeof e?(console.error("[camlsql] value was not a number",e),null):{type:"Number",value:e}},lookup:function(e){return{type:"Lookup",value:e,byId:"number"==typeof e}},now:function(e){return{type:"DateTime",isNow:!0,includeTime:1==e}},date:function(t){var n=e(t);return n.includeTime=!1,n},datetime:e,today:function(e){return void 0===e&&(e=0),"number"!=typeof e?(console.error("[camlsql] Bad offset value for 'today'",e),null):{type:"DateTime",today:!0,value:e}},multichoice:function(e){return{type:"MultiChoice",value:e}},choice:function(e){return{type:"Choice",value:e}},url:function(e){return{type:"URL",value:e}},user:function(e){return{type:"User",value:e}}}});